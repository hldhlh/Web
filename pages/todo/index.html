<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日清单</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
/* 变量定义 */
:root {
    /* 颜色变量 */
    --bg-color: #fff;
    --sidebar-bg: #fff;
    --sidebar-hover: #f4f4f5;
    --sidebar-active: rgba(10, 132, 255, 0.2);
    --sidebar-text: #555;
    --sidebar-active-text: #000;
    --primary-color: #007aff;
    --primary-hover: #0062cc;
    --text-color: #1d1d1f;
    --secondary-text: #86868b;
    --border-color: rgba(0, 0, 0, 0.1);
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --theme-purple: #bf5af2;
    --theme-blue: #0a84ff;
    --theme-red: #ff453a;
    --current-theme-color: var(--theme-purple);
    --current-theme-hover-bg: rgba(191, 90, 242, 0.1);
    --divider-color: rgba(0, 0, 0, 0.15);
    --mobile-divider-color: #d0d0d0;
}

/* 主题变量 */
body[data-theme=purple] {
    --current-theme-color: var(--theme-purple);
    --current-theme-hover-bg: rgba(191, 90, 242, 0.1);
}

body[data-theme=blue] {
    --current-theme-color: var(--theme-blue);
    --current-theme-hover-bg: rgba(10, 132, 255, 0.1);
}

body[data-theme=red] {
    --current-theme-color: var(--theme-red);
    --current-theme-hover-bg: rgba(255, 69, 58, 0.1);
}

/* 字体定义 */
@font-face {
    font-family: 'SF Pro Text';
    src: local('SF Pro Text'), local('SFProText-Regular');
    font-weight: 400;
    font-display: swap;
}

@font-face {
    font-family: 'SF Pro Display';
    src: local('SF Pro Display'), local('SFProDisplay-Regular');
    font-weight: 400;
    font-display: swap;
}

/* 基础样式 */
body {
    background-color: var(--bg-color);
    font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: var(--text-color);
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
}

/* 滚动条样式 */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.15);
    border-radius: 4px;
    border: 2px solid transparent;
}

::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.3);
}

.sidebar-list, 
.main-content, 
.task-list {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
}

/* 桌面端滚动条交互 */
@media (hover:hover) and (pointer:fine) {
    .sidebar-list::-webkit-scrollbar-thumb,
    .main-content::-webkit-scrollbar-thumb,
    .task-list::-webkit-scrollbar-thumb {
        background-color: transparent;
        transition: background-color 0.3s ease;
    }
    
    .sidebar-list.is-scrolling::-webkit-scrollbar-thumb,
    .main-content.is-scrolling::-webkit-scrollbar-thumb,
    .task-list.is-scrolling::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.15);
    }
    
    .sidebar-list,
    .main-content,
    .task-list {
        transition: scrollbar-color 0.3s ease;
        scrollbar-color: transparent transparent;
    }
    
    .sidebar-list.is-scrolling,
    .main-content.is-scrolling,
    .task-list.is-scrolling {
        scrollbar-color: rgba(0, 0, 0, 0.15) transparent;
    }
}

/* 移动端滚动条 - 始终保持隐藏状态，除非正在滚动 */
@media (hover:none) or (pointer:coarse) {
    .sidebar-list::-webkit-scrollbar,
    .main-content::-webkit-scrollbar,
    .task-list::-webkit-scrollbar {
        width: 0;
        height: 0;
    }
    
    .sidebar-list,
    .main-content,
    .task-list {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;     /* Firefox */
    }
    
    /* 滚动时临时显示的滚动指示器 */
    .scrolling-active {
        position: relative;
    }
    
    .scrolling-active::after {
        content: '';
        position: absolute;
        right: 2px;
        top: 4px;
        bottom: 4px;
        width: 4px;
        border-radius: 2px;
        background-color: rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    
    .scrolling-active.is-scrolling::after {
        opacity: 1;
    }
}

/* 布局容器 */
.app-container {
    display: flex;
    height: 100vh;
    width: 100%;
    overflow-x: hidden;
}

/* 侧边栏样式 */
.sidebar {
    width: 220px;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    height: 100%;
    position: fixed;
    left: 0;
    top: 0;
    z-index: 10;
    display: flex;
    flex-direction: column;
}

.sidebar-list {
    margin: 0;
    padding: 10px 0;
    list-style: none;
    overflow-y: auto;
    flex-grow: 1;
}

.sidebar-item {
    padding: 8px 15px;
    margin: 4px 5px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    height: 40px;
    font-size: 0.93rem;
    color: var(--text-color);
    position: relative;
}

.sidebar-item:hover {
    background-color: var(--sidebar-hover);
    border-radius: 8px;
}

.sidebar-item.active {
    background-color: var(--sidebar-active);
    color: var(--sidebar-active-text);
    font-weight: 500;
}

.sidebar-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    margin-right: 15px;
    font-size: 0.8rem;
    color: #fff;
    line-height: 1;
}

.sidebar-icon.purple {
    background-color: var(--theme-purple);
}

.sidebar-icon.blue {
    background-color: var(--theme-blue);
}

.sidebar-icon.red {
    background-color: var(--theme-red);
}

.sidebar-add {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    color: var(--theme-blue);
    display: flex;
    align-items: center;
    cursor: pointer;
}

.sidebar-add:hover {
    background-color: rgba(10, 132, 255, 0.1);
}

.sidebar-add i,
.sidebar-more i {
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

.sidebar-add i {
    margin-right: 15px;
    font-size: 1rem;
    color: var(--primary-color);
    width: 25px;
    height: 25px;
}

.sidebar-add span {
    font-size: 1rem;
    color: var(--primary-color);
}

.sidebar-more {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-text);
    cursor: pointer;
    opacity: 0;
    font-size: 0.9rem;
    width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: opacity 0.15s ease-in-out;
}

.sidebar-item:hover .sidebar-more {
    opacity: 1;
}

.sidebar-more:hover {
    background-color: rgba(0, 0, 0, 0.08);
}

/* 主内容区域 */
.main-content {
    flex: 1;
    padding: 15px 0;
    margin-left: 220px;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
    box-sizing: border-box;
    width: calc(100% - 220px);
}

.content-inner {
    padding: 0;
    max-width: none;
    width: 100%;
    position: relative;
}

.list-header {
    margin-bottom: 15px;
    padding: 0 20px 10px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.list-title {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 5px;
    font-family: 'SF Pro Display', -apple-system, sans-serif;
    color: var(--current-theme-color);
}

/* 任务列表样式 */
.task-list {
    list-style: none;
    padding: 0 20px;
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
    transition: scrollbar-color 0.3s ease;
}

.task-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    position: relative;
    width: 100%;
    box-sizing: border-box;
    margin: 0;
}

.task-content {
    display: flex;
    flex-direction: column;
    flex: 1;
    margin-left: 0px;
    position: relative;
    overflow: visible;
}

.task-item::after {
    content: '';
    position: absolute;
    left: 40px;
    bottom: 0;
    height: 1px;
    background-color: var(--divider-color);
    width: calc(100% - 40px);
    box-sizing: border-box;
    padding-left: 0;
    margin-left: 0;
    right: auto;
}

.task-item:last-child::after {
    display: none;
}

.task-checkbox {
    position: relative;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-left: 0;
    margin-right: 5px;
    appearance: none;
    border: 2px solid #c7c7cc;
    outline: none;
    cursor: pointer;
    flex-shrink: 0;
    background-color: #fff;
}

.task-checkbox:hover {
    border-color: var(--current-theme-color);
    background-color: var(--current-theme-hover-bg);
}

.task-checkbox:checked {
    border-color: var(--current-theme-color);
}

.task-checkbox:checked::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--current-theme-color);
}

.task-text {
    flex-grow: 1;
    margin-left: 5px;
    color: var(--text-color);
    font-size: 0.95rem;
    width: 100%;
    cursor: text;
    white-space: pre-wrap;
    word-break: break-word;
}

.task-note {
    font-size: 0.85rem;
    color: var(--secondary-text);
    margin-top: 3px;
}

.task-item.completed .task-text {
    color: var(--secondary-text);
}

.task-text.editing {
    outline: none;
    border-bottom: 1px dashed var(--current-theme-color);
    padding-bottom: 2px;
    min-height: 1.2em;
}

/* 头部操作区 */
.header-actions {
    display: flex;
    align-items: center;
    margin-left: auto;
    gap: 8px;
}

.header-action {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--current-theme-color);
    border-radius: 6px;
    margin: 0;
    padding: 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    transition: background-color 0.2s;
}

.header-action:hover {
    background-color: var(--current-theme-hover-bg);
}

.header-action svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 30px 0;
    color: var(--secondary-text);
}

/* 移动端头部 */
.mobile-header {
    display: none;
    padding: 15px 0;
    background-color: var(--bg-color);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
}

.mobile-back,
.mobile-actions {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
}

.mobile-back {
    left: 15px;
    font-size: 1.1rem;
    color: var(--current-theme-color);
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.mobile-back:hover {
    background-color: var(--current-theme-hover-bg);
}

.mobile-back svg {
    margin-right: 6px;
    width: 16px;
    height: 16px;
}

.mobile-title {
    text-align: center;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--current-theme-color);
}

.mobile-actions {
    right: 15px;
}

.mobile-action-btn:last-child {
    padding-right: 0;
}

/* 自定义加号图标 */
.custom-plus {
    position: relative;
    display: inline-block;
    width: 16px;
    height: 16px;
}

.custom-plus::before,
.custom-plus::after {
    content: '';
    position: absolute;
    background-color: currentColor;
    border-radius: 1px;
}

.custom-plus::before {
    width: 16px;
    height: 2px;
    top: 7px;
    left: 0;
}

.custom-plus::after {
    height: 16px;
    width: 2px;
    left: 7px;
    top: 0;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .sidebar {
        display: none;
        width: 100%;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 300;
        overflow-y: auto;
        background-color: #fff;
        padding-top: 0;
        display: flex;
        flex-direction: column;
    }
    
    .sidebar-list {
        flex-direction: column;
        padding: 0;
        padding-top: 20px;
        margin: 0;
        background-color: #fff;
        flex-grow: 1;
        overflow-y: auto;
        border-radius: 0;
    }
    
    .sidebar-item {
        padding: 15px;
        margin: 4px 10px;
        border-radius: 0;
        font-size: 1rem;
        text-align: left;
        height: 40px;
        position: relative;
    }
    
    .sidebar-item.active {
        background-color: transparent;
        color: var(--text-color);
        font-weight: 400;
    }
    
    .sidebar-item::after {
        content: '›';
        position: absolute;
        right: 15px;
        font-size: 1.5rem;
        color: #c7c7cc;
    }
    
    .sidebar-item:hover {
        background-color: var(--sidebar-hover);
        border-radius: 8px;
    }
    
    .sidebar-more {
        display: none;
        opacity: 1;
        right: 45px;
    }
    
    .sidebar-more:hover {
        background-color: rgba(0, 0, 0, 0.08);
    }
    
    .sidebar-icon {
        margin-right: 15px;
        margin-bottom: 0;
    }
    
    .sidebar-add {
        border-top: 1px solid #f0f0f0;
        margin-top: auto;
        position: sticky;
        bottom: 0;
        z-index: 10;
        width: 100%;
        background-color: #fff;
    }
    
    .mobile-header {
        padding: 15px 0;
    }
    
    .list-header {
        display: none;
    }
    
    .main-content {
        margin-left: 0;
        padding: 60px 0 0;
        height: calc(100vh - 60px);
        overflow-y: auto;
        background-color: #fff;
        width: 100%;
    }
    
    .task-list {
        background-color: #fff;
        border-radius: 0;
        box-shadow: none;
        margin: 0;
        padding: 0;
        width: 100%;
        overflow-x: hidden;
        overflow-y: auto;
    }
    
    .task-item {
        padding: 15px 15px;
    }
    
    .task-content {
        padding: 0 5px;
    }
    
    .task-item::after {
        background-color: var(--mobile-divider-color);
        width: 100vw;
        left: 50px;
    }
    
    .task-checkbox {
        width: 22px;
        height: 22px;
    }
    
    .task-text {
        font-size: 1rem;
        padding-right: 35px;
    }
    
    .mobile-title {
        flex: 1;
        text-align: center;
        font-weight: 600;
        font-size: 1.3rem;
    }
    
    .mobile-back {
        padding: 8px;
        left: 0;
    }
    
    .mobile-back span {
        font-size: 1rem;
        line-height: 1;
    }
    
    .mobile-actions {
        right: 0;
        display: flex;
    }
    
    .empty-state {
        margin: 0;
        padding: 30px 20px;
        background-color: #fff;
        border-radius: 0;
        box-shadow: none;
    }
    
    .app-container {
        padding: 0;
        border-radius: 0;
        max-height: 100%;
        height: 100dvh;
    }
    
    .app-header {
        padding: 10px 15px;
        border-radius: 0;
    }
    
    .task-item .info-task-btn {
        right: 2px !important;
        opacity: 0 !important;
    }
    
    .task-item:hover .info-task-btn {
        opacity: 1 !important;
    }
    
    .task-text {
        font-size: 1rem;
        padding-right: 35px;
    }
    
    .sidebar-popup-menu {
        position: fixed;
        top: auto !important;
        left: auto !important;
        right: 20px !important;
    }
}

/* 任务操作按钮 */
.task-item .info-task-btn {
    position: absolute !important;
    right: 2px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: none;
    border: none;
    color: var(--secondary-text);
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    font-size: 1.1rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    opacity: 0 !important;
    transition: opacity 0.15s ease-in-out, background-color 0.15s ease-in-out;
}

.task-item:hover .info-task-btn {
    opacity: 1 !important;
}

.info-task-btn:hover {
    background-color: rgba(0, 0, 0, 0.08);
    color: var(--current-theme-color);
}

.task-item .delete-task-btn,
.task-item .info-task-btn {
    opacity: 1;
    right: 15px;
}

.task-item .info-task-btn {
    right: 50px;
}

.task-text {
    font-size: 1rem;
    padding-right: 75px;
}

/* 任务弹出菜单 */
.task-popup-menu {
    position: fixed;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 8px 0;
    min-width: 120px;
    z-index: 1000;
    display: none;
    border: 1px solid var(--border-color);
    /* 添加动画过渡 */
    transition: opacity 0.2s, transform 0.25s;
    opacity: 0;
    transform: translateY(10px);
}

.task-popup-menu.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

.task-popup-menu-item {
    padding: 8px 15px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
}

.task-popup-menu-item:hover {
    background-color: var(--sidebar-hover);
}

.task-popup-menu-item.delete {
    color: var(--theme-red);
}

.task-popup-menu-item i {
    margin-right: 8px;
    font-size: 14px;
}

/* 提示信息 */
.toast-message {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s;
}

.toast-message.show {
    opacity: 1;
}

/* 侧边栏弹出菜单 */
.sidebar-popup-menu {
    position: fixed;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 8px 0;
    min-width: 120px;
    z-index: 1000;
    display: none;
    border: 1px solid var(--border-color);
}

.sidebar-popup-menu.show {
    display: block;
}

.sidebar-popup-menu-item {
    padding: 8px 15px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
}

.sidebar-popup-menu-item:hover {
    background-color: var(--sidebar-hover);
}

.sidebar-popup-menu-item.delete {
    color: var(--theme-red);
}

.sidebar-popup-menu-item i {
    margin-right: 8px;
    font-size: 14px;
}

/* 列表操作菜单 */
.list-popup-menu {
    position: fixed;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 8px 0;
    min-width: 200px;
    z-index: 1000;
    display: none;
    border: 1px solid var(--border-color);
}

.list-popup-menu.show {
    display: block;
}

.list-popup-menu-item {
    padding: 10px 15px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
}

.list-popup-menu-item:hover {
    background-color: var(--sidebar-hover);
}

.list-popup-menu-item.delete {
    color: var(--theme-red);
}

.list-popup-menu-item i {
    margin-right: 10px;
    font-size: 16px;
}

/* 列表项文本 */
.sidebar-item span {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sidebar-item span.editing {
    outline: none;
    border-bottom: 1px dashed var(--current-theme-color);
    padding-bottom: 2px;
    min-width: 30px;
}

/* 移动端返回按钮和图标优化 */
.mobile-back {
    display: flex;
    align-items: center;
}

.mobile-back svg {
    margin-right: 6px;
    width: 16px;
    height: 16px;
}

/* 自定义加号图标线条 */
.custom-plus::before,
.custom-plus::after {
    content: '';
    position: absolute;
    background-color: currentColor;
    border-radius: 1px;
}

/* 移动端菜单样式优化 */
@media (max-width: 768px) {
    .task-popup-menu {
        width: 90%;
        max-width: 300px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 10px 0;
        left: 50% !important;
        transform: translateX(-50%);
        bottom: 20px !important;
        top: auto !important;
    }
    
    .task-popup-menu-item {
        padding: 14px 20px;
        font-size: 16px;
    }
    
    .task-popup-menu-item i {
        font-size: 18px;
        margin-right: 15px;
    }
    
    .task-popup-menu-item.delete {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        margin-top: 5px;
        padding-top: 15px;
    }
}

/* 移动端遮罩层 */
.mobile-menu-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 999;
    display: none;
    opacity: 0;
    transition: opacity 0.2s;
}

.mobile-menu-backdrop.show {
    display: block;
    opacity: 1;
}

.color-theme-dialog {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.color-dialog-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    width: 320px;
    max-width: 90%;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.color-dialog-content h3 {
    margin: 0 0 20px 0;
    font-size: 18px;
    text-align: center;
}

.color-options {
    display: flex;
    justify-content: space-around;
    margin-bottom: 25px;
}

.color-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: background-color 0.2s;
}

.color-option:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.color-option.active {
    background-color: rgba(0, 0, 0, 0.1);
}

.color-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-bottom: 8px;
}

.color-option.purple .color-circle {
    background-color: var(--theme-purple);
}

.color-option.blue .color-circle {
    background-color: var(--theme-blue);
}

.color-option.red .color-circle {
    background-color: var(--theme-red);
}

.color-name {
    font-size: 14px;
}

.color-dialog-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.color-dialog-buttons button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
    cursor: pointer;
}

.color-cancel-btn {
    background-color: #f1f1f1;
    color: #333;
}

.color-confirm-btn {
    background-color: var(--primary-color);
    color: white;
}
    </style>
</head>
<body data-theme="purple">
    <div class="app-container">
        <div class="mobile-header">
            <div class="mobile-back">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M10 3L5 8l5 5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
                <span>列表</span>
            </div>
            <div class="mobile-title">每日清单</div>
            <div class="mobile-actions">
                <div class="header-action add-task-btn" tabindex="-1" onclick="createEmptyEditableTask()">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                    </svg>
                </div>
                <div class="header-action" tabindex="-1">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <ul class="sidebar-list">
                <li class="sidebar-item active">
                    <div class="sidebar-icon purple">每</div>
                    <span>每日清单</span>
                    <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                    <div class="sidebar-popup-menu">
                        <div class="sidebar-popup-menu-item edit"><i class="bi bi-pencil"></i>编辑名称</div>
                        <div class="sidebar-popup-menu-item delete"><i class="bi bi-trash3"></i>删除列表</div>
                    </div>
                </li>
                <li class="sidebar-item">
                    <div class="sidebar-icon blue">心</div>
                    <span>心情</span>
                    <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                    <div class="sidebar-popup-menu">
                        <div class="sidebar-popup-menu-item edit"><i class="bi bi-pencil"></i>编辑名称</div>
                        <div class="sidebar-popup-menu-item delete"><i class="bi bi-trash3"></i>删除列表</div>
                    </div>
                </li>
                <li class="sidebar-item">
                    <div class="sidebar-icon red">生</div>
                    <span>生日备注</span>
                    <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                    <div class="sidebar-popup-menu">
                        <div class="sidebar-popup-menu-item edit"><i class="bi bi-pencil"></i>编辑名称</div>
                        <div class="sidebar-popup-menu-item delete"><i class="bi bi-trash3"></i>删除列表</div>
                    </div>
                </li>
            </ul>
            <div class="sidebar-add" tabindex="-1"><i class="bi bi-plus-circle"></i><span>添加列表</span></div>
        </div>
        
        <div class="main-content">
            <div class="content-inner">
                <div class="list-header">
                    <h1 class="list-title">每日清单</h1>
                    <div class="header-actions">
                        <div class="header-action add-task-btn" tabindex="-1" onclick="createEmptyEditableTask()">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                            </svg>
                        </div>
                        <div class="header-action" tabindex="-1">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <ul class="task-list" id="task-list"><div class="empty-state">载入中...</div></ul>
            </div>
        </div>
    </div>

    <div id="custom-confirm" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.65);z-index:2000;justify-content:center;align-items:center;">
        <div style="background-color:white;border-radius:12px;width:460px;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,0.15);overflow:hidden;display:flex;flex-direction:column;">
            <div style="padding:40px 40px 30px 40px;text-align:center;display:flex;flex-direction:column;justify-content:center;min-height:140px;">
                <h3 id="confirm-title" style="margin:0 0 16px 0;font-size:22px;font-weight:600;letter-spacing:-0.2px;color:#333;"></h3>
                <p id="confirm-message" style="margin:0;color:#666;font-size:16px;line-height:1.5;"></p>
            </div>
            <div style="display:flex;padding:0 40px 40px 40px;gap:16px;justify-content:center;">
                <button id="confirm-cancel" style="width:180px;height:38px;background-color:#007bff;border:none;border-radius:8px;font-size:16px;cursor:pointer;color:white;font-weight:500;transition:all 0.2s ease;padding:0;box-shadow:0 2px 4px rgba(0,123,255,0.2);" onmouseover="this.style.backgroundColor='#0069d9';this.style.boxShadow='0 4px 8px rgba(0,123,255,0.3)';" onmouseout="this.style.backgroundColor='#007bff';this.style.boxShadow='0 2px 4px rgba(0,123,255,0.2)';">取消</button>
                <button id="confirm-ok" style="width:180px;height:38px;background-color:#f5f5f5;border:none;border-radius:8px;font-size:16px;cursor:pointer;color:#ff453a;font-weight:500;transition:all 0.2s ease;padding:0;box-shadow:0 2px 4px rgba(0,0,0,0.05);" onmouseover="this.style.backgroundColor='#e8e8e8';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.backgroundColor='#f5f5f5';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">删除</button>
            </div>
        </div>
    </div>
    
    <!-- 移动端菜单遮罩 -->
    <div id="mobile-menu-backdrop" class="mobile-menu-backdrop"></div>
    
    <!-- 列表操作弹出菜单 -->
    <div id="list-popup-menu" class="list-popup-menu">
        <div class="list-popup-menu-item" data-action="show-all">
            <i class="bi bi-list"></i>
            <span>显示全部</span>
        </div>
        <div class="list-popup-menu-item" data-action="show-completed-only">
            <i class="bi bi-check-circle"></i>
            <span>仅显示已完成</span>
        </div>
        <div class="list-popup-menu-item" data-action="show-uncompleted-only">
            <i class="bi bi-circle"></i>
            <span>仅显示未完成</span>
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://fmxddvjgkykuqwmasigo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZteGRkdmpna3lrdXF3bWFzaWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwNDMzMjcsImV4cCI6MjA1OTYxOTMyN30.XCU4-03oajGh6M2-PNiBotCZSIDn_nJXkIC0Thjjfqo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // === Supabase Realtime 实时推送订阅 ===
        // 订阅 todos 表的所有变动，实现多端实时同步
        supabase
          .channel('public:todos')
          .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'todos' },
            payload => {
              // 只要有变动，自动刷新任务列表
              // 可根据payload.eventType做更细粒度处理
              loadBirthdays();
            }
          )
          .subscribe();

        const taskList = document.getElementById('task-list');
        const sidebarList = document.querySelector('.sidebar-list');

        // 记录最近添加的任务
        window.lastAddedTask = {
            text: null,
            timestamp: 0
        };
        
        async function loadBirthdays(filteredTasks = null) {
            try {
                // 设置加载标志，防止递归调用
                if (window.isLoadingData) return;
                window.isLoadingData = true;
                
                // 保存当前正在编辑的临时任务（如果有）
                const tempTask = window.currentEditingTempTask;
                let tempTaskText = '';
                let shouldPreserveTempTask = false;
                
                // 检查正在编辑的临时任务
                if (tempTask && tempTask.parentNode) {
                    const textElement = tempTask.querySelector('.task-text');
                    if (textElement) {
                        tempTaskText = textElement.textContent.trim();
                        shouldPreserveTempTask = (tempTaskText !== '');
                        
                        // 如果有文本内容，尝试保存
                        if (tempTaskText !== '') {
                            try {
                                // 如果编辑中的临时任务有内容，但不想保存并重新加载
                                // 不执行保存操作，只保留临时任务
                            } catch (error) {
                                console.error('保存临时任务失败:', error);
                            }
                        } else {
                            // 如果临时任务为空，移除它
                            shouldPreserveTempTask = false;
                            if (tempTask.parentNode) {
                                tempTask.parentNode.removeChild(tempTask);
                            }
                            window.currentEditingTempTask = null;
                        }
                    }
                }
                
                // 显示加载中状态，但保留任何正在编辑的任务
                if (!shouldPreserveTempTask && !document.querySelector('.task-item.temp-task') && !filteredTasks) {
                    taskList.innerHTML = `<div class="empty-state">载入中...</div>`;
                }
                
                // 如果提供了已过滤的任务列表，则直接使用它而不是从服务器获取数据
                if (filteredTasks) {
                    // 转换为数组格式以适配renderTaskItems函数
                    const tasksArray = Array.from(filteredTasks).map(taskItem => {
                        return {
                            id: taskItem.dataset.id,
                            task: taskItem.querySelector('.task-text').textContent,
                            note: taskItem.querySelector('.task-note')?.textContent || '',
                            is_completed: taskItem.classList.contains('completed'),
                            created_at: taskItem.querySelector('.info-task-btn')?.dataset.createdAt
                        };
                    });
                    
                    // 使用筛选后的任务渲染UI
                    renderTaskItems(tasksArray, 'task', shouldPreserveTempTask ? tempTask : null, tempTaskText);
                    
                    // 设置筛选状态标记
                    window.currentFilterState = 'filtered'; // 需要确保 filterType 在调用 loadBirthdays 时传递
                    
                    // 添加筛选提示
                    // 注意: showFilterStatus 依赖全局 filterType, 这里可能需要调整或确保 filterType 正确传递
                    // 暂时假设 filterType 是通过其他方式设置的，或者 showFilterStatus 能处理 null
                    showFilterStatus(tasksArray.length, window.currentFilterState);


                } else {
                    // 正常从服务器获取所有数据
                    const { data, error } = await supabase
                        .from('todos')
                        .select('id, task, is_completed, created_at')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;

                    // 移除筛选状态
                    window.currentFilterState = null;
                    
                    // 移除筛选提示
                    hideFilterStatus();
                    
                    // 渲染数据，并保留临时任务（如果需要）
                    renderBirthdays(data || [], shouldPreserveTempTask ? tempTask : null, tempTaskText);
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                // 仍然显示错误消息，除非有临时任务
                if (!window.currentEditingTempTask) {
                    taskList.innerHTML = `<div class="empty-state">加载失败，请重试</div>`;
                }
            } finally {
                // 重置加载标志
                setTimeout(() => {
                    window.isLoadingData = false;
                }, 300);
            }
        }
        
        // 显示筛选状态提示
        function showFilterStatus(count, filterType) {
            // 获取或创建状态提示元素
            let statusElement = document.getElementById('filter-status');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'filter-status';
                statusElement.style.cssText = `
                    position: sticky;
                    top: 0;
                    background-color: var(--bg-color);
                    padding: 8px 20px;
                    font-size: 14px;
                    color: var(--current-theme-color);
                    border-bottom: 1px solid var(--border-color);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    z-index: 10;
                `;
                
                const clearButton = document.createElement('button');
                clearButton.textContent = '清除筛选';
                clearButton.style.cssText = `
                    background: none;
                    border: none;
                    color: var(--current-theme-color);
                    cursor: pointer;
                    padding: 4px 8px;
                    font-size: 12px;
                    border-radius: 4px;
                `;
                clearButton.addEventListener('mouseover', () => {
                    clearButton.style.backgroundColor = 'var(--current-theme-hover-bg)';
                });
                clearButton.addEventListener('mouseout', () => {
                    clearButton.style.backgroundColor = 'transparent';
                });
                clearButton.addEventListener('click', () => {
                    loadBirthdays(); // 重新加载所有任务
                });
                
                statusElement.appendChild(clearButton);
                
                // 插入到任务列表的前面
                const taskList = document.getElementById('task-list');
                if (taskList) {
                    taskList.parentNode.insertBefore(statusElement, taskList);
                }
            }
            
            // 更新筛选状态文本
            let filterText = '';
            if (filterType === 'completed') {
                filterText = '仅显示已完成';
            } else if (filterType === 'uncompleted') {
                filterText = '仅显示未完成';
            } else {
                filterText = '显示全部';
            }
            statusElement.innerHTML = `<span>已筛选: ${filterText} (${count} 个任务)</span>
                <button id="clear-filter" style="background:none;border:none;color:var(--current-theme-color);cursor:pointer;padding:4px 8px;font-size:12px;border-radius:4px;">清除筛选</button>`;
            
            // 添加清除筛选按钮事件
            document.getElementById('clear-filter').addEventListener('click', () => {
                loadBirthdays(); // 重新加载所有任务
            });
            
            // 显示状态提示
            statusElement.style.display = 'flex';
        }
        
        // 隐藏筛选状态提示
        function hideFilterStatus() {
            const statusElement = document.getElementById('filter-status');
            if (statusElement) {
                statusElement.style.display = 'none';
            }
        }

        function renderBirthdays(birthdays, tempTask, tempTaskText) {
            if ((!birthdays || !Array.isArray(birthdays) || birthdays.length === 0) && !tempTask) {
                // 移除了模拟数据，改为显示空列表提示
                taskList.innerHTML = '<div class="empty-state">列表为空，快来添加新任务吧！</div>';
                return;
            }

            renderTaskItems(birthdays, 'task', tempTask, tempTaskText);
        }

        function renderTaskItems(items, textProperty, tempTask, tempTaskText) {
            // 保存当前正在编辑的临时任务
            let shouldPreserveTempTask = tempTask && tempTask.parentNode && tempTaskText && tempTaskText.trim() !== '';
            
            let html = '';
            items.forEach(item => {
                // 格式化创建时间
                let creationTime = '未知';
                if (item.created_at) {
                    try {
                        creationTime = new Date(item.created_at).toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                    } catch (e) {
                        console.error('格式化时间失败:', item.created_at, e);
                    }
                }

                html += `<li class="task-item ${item.is_completed ? 'completed' : ''}" data-id="${item.id}">
    <input type="checkbox" class="task-checkbox" ${item.is_completed ? 'checked' : ''}>
    <div class="task-content">
        <span class="task-text" contenteditable="false">${(item[textProperty] || '').replace(/\n/g, '<br>')}</span>
        ${item.note ? `<div class="task-note">${item.note}</div>` : ''}
        <button class="info-task-btn" tabindex="-1" data-created-at="${item.created_at || ''}"><i class="bi bi-three-dots-vertical"></i></button>
        <div class="task-popup-menu">
            <div class="task-popup-menu-item view-info">
                <i class="bi bi-info-circle"></i>创建: ${creationTime}
            </div>
            <div class="task-popup-menu-item copy">
                <i class="bi bi-clipboard"></i>复制
            </div>
            <div class="task-popup-menu-item delete">
                <i class="bi bi-trash3"></i>删除
            </div>
        </div>
    </div>
</li>`;
            });
            
            // 如果当前没有临时任务，直接渲染
            if (!shouldPreserveTempTask) {
                taskList.innerHTML = html;
                
                // 为每个任务项应用菜单功能
                document.querySelectorAll('.task-item').forEach(taskItem => {
                    ensureTaskMenuFunctionality(taskItem);
                });
            } else {
                // 保留临时任务，先移除它
                if (tempTask.parentNode) {
                    tempTask.parentNode.removeChild(tempTask);
                }
                
                // 渲染新的任务列表
                taskList.innerHTML = html;
                
                // 为每个任务项应用菜单功能
                document.querySelectorAll('.task-item').forEach(taskItem => {
                    ensureTaskMenuFunctionality(taskItem);
                });
                
                // 将临时任务重新添加到顶部
                if (taskList.firstChild) {
                    taskList.insertBefore(tempTask, taskList.firstChild);
                } else {
                    taskList.appendChild(tempTask);
                }
                
                // 确保临时任务的菜单功能正常
                ensureTaskMenuFunctionality(tempTask);
                
                // 重新聚焦到临时任务
                const textElement = tempTask.querySelector('.task-text');
                if (textElement) {
                    textElement.focus();
                    
                    // 将光标放到文本的末尾
                    const range = document.createRange();
                    const selection = window.getSelection();
                    range.selectNodeContents(textElement);
                    range.collapse(false); // 折叠到末尾
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            
            setupTaskListeners();
        }

        function setupTaskListeners() {
            taskList.removeEventListener('change', handleTaskChange);
            taskList.addEventListener('change', handleTaskChange);
            
            // 移除旧的事件监听器，防止重复绑定
            taskList.removeEventListener('click', handleTaskClick);
            taskList.addEventListener('click', handleTaskClick);
            
            // 监听键盘事件，处理编辑完成
            taskList.removeEventListener('keydown', handleTaskKeydown);
            taskList.addEventListener('keydown', handleTaskKeydown);
            
            // 监听失去焦点事件，保存编辑内容
            taskList.removeEventListener('focusout', handleTaskFocusOut);
            taskList.addEventListener('focusout', handleTaskFocusOut);
        }

        function handleTaskChange(event) {
            if (event.target.classList.contains('task-checkbox')) {
                const checkbox = event.target;
                const taskItem = checkbox.closest('.task-item');
                if (!taskItem) return;

                const id = taskItem.dataset.id;
                const isCompleted = checkbox.checked;

                taskItem.classList.toggle('completed', isCompleted);
                toggleTaskStatus(id, isCompleted);
            }
        }

        function handleTaskClick(event) {
            // 如果有正在编辑的临时任务，先处理它
            if (window.currentEditingTempTask) {
                const textElement = window.currentEditingTempTask.querySelector('.task-text');
                if (textElement && !window.currentEditingTempTask.contains(event.target)) {
                    // 检查是否已经在保存过程中
                    if (window.currentEditingTempTask.dataset.saving === "true") {
                        console.log("任务已经在保存中，避免重复保存");
                        return;
                    }
                    
                    const newText = textElement.textContent.trim();
                    if (newText !== '') {
                        // 标记为正在保存
                        window.currentEditingTempTask.dataset.saving = "true";
                        
                        // 将文本框设为不可编辑
                        textElement.contentEditable = "false";
                        textElement.classList.remove('editing');
                        
                        // 添加新任务
                        addTask(newText);
                    }
                    
                    // 移除临时任务
                    if (window.currentEditingTempTask.parentNode) {
                        window.currentEditingTempTask.parentNode.removeChild(window.currentEditingTempTask);
                    }
                    
                    window.currentEditingTempTask = null;
                }
            }
            
            // 如果点击的是信息按钮
            if (event.target.closest('.info-task-btn')) {
                const infoButton = event.target.closest('.info-task-btn');
                const taskItem = infoButton.closest('.task-item');
                
                if (taskItem) {
                    const menuElement = taskItem.querySelector('.task-popup-menu');
                    const backdrop = document.getElementById('mobile-menu-backdrop');
                    
                    // 关闭所有其他打开的菜单
                    document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                        if (menu !== menuElement) {
                            menu.classList.remove('show');
                        }
                    });
                    
                    // 切换当前菜单的显示状态
                    menuElement.classList.toggle('show');
                    
                    // 移动端处理遮罩层
                    if (window.innerWidth <= 768) {
                        if (menuElement.classList.contains('show')) {
                            backdrop.classList.add('show');
                        } else {
                            backdrop.classList.remove('show');
                        }
                    }
                    
                    // 根据按钮位置调整菜单位置
                    positionPopupMenu(infoButton, menuElement);
                    
                    // 阻止事件冒泡，防止立即触发document点击事件关闭菜单
                    event.stopPropagation();
                }
                return; // 阻止进一步处理
            }
            
            // 处理菜单项点击
            if (event.target.closest('.task-popup-menu-item')) {
                const menuItem = event.target.closest('.task-popup-menu-item');
                const taskItem = menuItem.closest('.task-item');
                const taskId = taskItem.dataset.id;
                
                // 点击删除选项
                if (menuItem.classList.contains('delete')) {
                    // 使用自定义对话框删除任务
                    showCustomConfirm(
                        '删除任务？', 
                        '此任务将被永久删除', 
                        () => deleteTask(taskId)
                    );
                }
                
                // 点击复制选项
                if (menuItem.classList.contains('copy')) {
                    const taskText = taskItem.querySelector('.task-text').textContent;
                    copyToClipboard(taskText);
                    // 显示一个小提示，表明已复制
                    showToast('已复制到剪贴板');
                }
                
                // 关闭菜单
                const menuElement = taskItem.querySelector('.task-popup-menu');
                menuElement.classList.remove('show');
                
                // 隐藏遮罩层
                document.getElementById('mobile-menu-backdrop').classList.remove('show');
                
                event.stopPropagation();
                return;
            }
            
            // 如果点击的是文本元素
            if (event.target.classList.contains('task-text')) {
                const textElement = event.target;
                const taskItem = textElement.closest('.task-item');
                
                // 如果任务已完成，不允许编辑
                if (taskItem.classList.contains('completed')) return;
                
                // 启用编辑
                enableTaskEditing(textElement);
            }
        }

        // 弹出菜单位置调整函数
        function positionPopupMenu(e,t){
            const i=e.getBoundingClientRect();
            const n=t.getBoundingClientRect(); // 修复：使用t.getBoundingClientRect()获取正确的尺寸
            const s=window.innerWidth-i.right<n.width;
            const a=window.innerWidth<=768;
            
            t.style.top="";
            t.style.right="";
            t.style.left="";
            
            if (a) {
                // 移动端使用CSS的固定定位在底部，不需要计算位置
                // 如果已经添加了相应的CSS样式，这里可以不做任何调整
                // 为了防止其他JS修改，再次强制设置位置
                t.style.left = '50%';
                t.style.bottom = '20px';
                t.style.transform = 'translateX(-50%)';
                t.style.top = 'auto';
            } else {
                // PC端保持原有的定位逻辑
                t.style.top=`${i.top}px`;
                if (s) {
                    t.style.right=`${window.innerWidth-i.left+5}px`;
                } else {
                    t.style.left=`${i.right+5}px`;
                }
            }
        }

        // 列表操作菜单定位函数
        function positionListMenu(button, menu) {
            const buttonRect = button.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const isMobile = window.innerWidth <= 768;
            
            // 重置菜单位置
            menu.style.top = "";
            menu.style.right = "";
            menu.style.left = "";
            
            if (isMobile) {
                // 移动端菜单定位在按钮正下方
                menu.style.top = `${buttonRect.bottom + 5}px`;
                menu.style.left = `${buttonRect.left + buttonRect.width/2 - menuRect.width/2}px`;
                
                // 确保菜单不超出屏幕
                const menuLeft = parseInt(menu.style.left);
                if (menuLeft < 10) {
                    menu.style.left = "10px";
                }
                if (menuLeft + menuRect.width > window.innerWidth - 10) {
                    menu.style.left = `${window.innerWidth - menuRect.width - 10}px`;
                }
            } else {
                // PC端菜单定位在按钮下方
                menu.style.top = `${buttonRect.bottom + 5}px`;
                
                // 确保菜单不超出右侧屏幕
                if (window.innerWidth - buttonRect.right < menuRect.width) {
                    // 如果右侧空间不足，向左展开
                    menu.style.right = `${window.innerWidth - buttonRect.right}px`;
                } else {
                    // 否则从左侧对齐
                    menu.style.left = `${buttonRect.left}px`;
                }
            }
        }

        // 侧边栏弹出菜单位置调整函数
        function positionSidebarMenu(e,t){
            const i=e.getBoundingClientRect();
            const n=t.getBoundingClientRect(); // 修复：使用t.getBoundingClientRect()获取正确的尺寸
            
            t.style.top="";
            t.style.right="";
            t.style.left="";
            t.style.top=`${i.top}px`;
            
            const s=window.innerWidth-i.right<n.width;
            s?t.style.right=`${window.innerWidth-i.left+5}px`:
            t.style.left=`${i.right+5}px`;
        }

        function handleTaskKeydown(event) {
            if (event.target.classList.contains('task-text') && event.target.contentEditable === 'true') {
                // 按下Ctrl+Enter组合键完成编辑
                if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                    event.preventDefault();
                    finishEditing(event.target);
                }
                // 按下Escape键取消编辑
                else if (event.key === 'Escape') {
                    event.preventDefault();
                    cancelEditing(event.target);
                }
                // 普通回车键，不拦截，让浏览器实现默认的换行行为
            }
        }

        function handleTaskFocusOut(event) {
            if (event.target.classList.contains('task-text') && event.target.contentEditable === 'true') {
                finishEditing(event.target);
            }
        }

        function finishEditing(textElement) {
            const taskItem = textElement.closest('.task-item');
            const taskId = taskItem.dataset.id;
            const newText = htmlToPlainText(textElement.innerHTML);
            
            // 确保内容不为空
            if (newText === '') {
                cancelEditing(textElement);
                return;
            }
            
            // 更新UI
            textElement.contentEditable = "false";
            textElement.classList.remove('editing');
            
            // 检查是否为临时任务
            if (taskItem.classList.contains('temp-task') || (typeof taskId === 'string' && taskId.startsWith('temp-'))) {
                // 如果是临时任务，直接添加为新任务
                addTask(newText);
                if (taskItem && taskItem.parentNode) {
                    taskItem.parentNode.removeChild(taskItem);
                }
            } else {
                // 更新现有任务
                updateTaskText(taskId, newText);
            }
        }

        function cancelEditing(textElement) {
            const taskItem = textElement.closest('.task-item');
            
            // 检查是否为临时任务
            if (taskItem.classList.contains('temp-task') || taskItem.dataset.tempFlag) {
                // 如果是临时任务，添加动画效果后移除
                if (taskItem && taskItem.parentNode) {
                    // 添加淡出动画
                    taskItem.style.transition = 'opacity 0.3s ease';
                    taskItem.style.opacity = '0';
                    
                    // 等待动画完成后移除
                    setTimeout(() => {
                        if (taskItem && taskItem.parentNode) {
                            taskItem.parentNode.removeChild(taskItem);
                        }
                    }, 300);
                }
                return;
            }
            
            const taskId = taskItem.dataset.id;
            
            // 通过重新加载数据来取消编辑
            loadBirthdays();
        }

        async function updateTaskText(id, newText) {
            try {
                // 检查ID类型，防止类型错误
                if (typeof id === 'string' && (id.startsWith('temp-') || id.startsWith('new-task-'))) {
                    console.warn('尝试更新临时任务，将作为新任务添加');
                    addTask(newText);
                    return;
                }
                
                // 确保文本中的换行被保留
                const { error } = await supabase
                    .from('todos')
                    .update({ task: newText })
                    .eq('id', id);
                
                if (error) throw error;
            } catch (error) {
                console.error('更新任务内容失败:', error);
                alert('更新失败: ' + error.message);
                loadBirthdays(); // 出错时重新加载
            }
        }

        async function addTask(taskText) {
            const normalizedText = (taskText || '').trim();
            // 初始化待插入集合
            if (!window.pendingInsertTexts) window.pendingInsertTexts = new Set();
            // 如果文本正在插入中，直接返回
            if (window.pendingInsertTexts.has(normalizedText)) {
                console.warn('检测到相同文本正在插入中，忽略本次调用');
                return null;
            }
            // 将文本标记为待插入
            window.pendingInsertTexts.add(normalizedText);
            try {
                // --- 原有短时间判断保留，可适当放宽时间 ---
                if (window.lastAddedTask &&
                    window.lastAddedTask.text === normalizedText &&
                    (Date.now() - window.lastAddedTask.timestamp) < 1500) {
                    console.warn('短时间重复添加，相同文本已存在，忽略');
                    window.pendingInsertTexts.delete(normalizedText);
                    return null;
                }
                // ------------------------------------------------
                // 声明tempId变量在函数作用域的开头，使其在catch块中也可访问
                let tempId = 'temp-' + Date.now();
                try {
                    // 检查任务文本是否为空
                    if (!taskText || taskText.trim() === '') {
                        console.warn('任务内容不能为空');
                        return null;
                    }
                    
                    // 更新最近添加的任务记录
                    window.lastAddedTask = {
                        text: taskText,
                        timestamp: Date.now()
                    };
                    
                    // 创建临时任务对象
                    const taskObj = {
                        id: tempId,
                        task: taskText,
                        is_completed: false,
                        created_at: new Date().toISOString()
                    };
                    
                    // 使用renderTaskItemHTML创建带完整菜单的任务HTML
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = renderTaskItemHTML(taskObj);
                    
                    // 如果有"载入中..."或"空列表"状态，则清除
                    const emptyState = document.querySelector('.empty-state');
                    if (emptyState) {
                        taskList.innerHTML = '';
                    }
                    
                    // 添加到列表顶部
                    const taskListElem = document.getElementById('task-list');
                    const newTaskItem = tempElement.firstChild;
                    // 新增挂标记，后续实时推送时可识别
                    newTaskItem.classList.add('pending-sync');
                    newTaskItem.dataset.pendingSync = 'true';
                    
                    // 设置动画效果
                    newTaskItem.style.opacity = '0';
                    newTaskItem.style.transition = 'opacity 0.3s ease';
                    
                    // 插入新任务到列表顶部
                    console.log("插入新任务元素到列表顶部");
                    if (taskList.firstChild) {
                        taskList.insertBefore(newTaskItem, taskList.firstChild);
                    } else {
                        taskList.appendChild(newTaskItem);
                    }
                    
                    // 淡入效果
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            newTaskItem.style.opacity = '1';
                        });
                    });
                    
                    // 发送到服务器，保留换行符
                    const { data, error } = await supabase
                        .from('todos')
                        .insert([{ task: taskText, is_completed: false }])
                        .select();
                    
                    if (error) throw error;
                    
                    // 用真实ID替换临时ID
                    if (data && data.length > 0) {
                        const newTask = data[0];
                        const tempTask = document.querySelector(`[data-id="${tempId}"]`);
                        if (tempTask) {
                            tempTask.dataset.id = newTask.id;
                            
                            // 确保菜单功能正常
                            ensureTaskMenuFunctionality(tempTask);
                            
                            // 确保重新绑定事件处理程序
                            setupTaskListeners();
                            
                            // 为确保菜单正常弹出，可以重新应用一次事件委托
                            const infoBtn = tempTask.querySelector('.info-task-btn');
                            if (infoBtn) {
                                infoBtn.addEventListener('click', function(e) {
                                    const taskItem = this.closest('.task-item');
                                    if (taskItem) {
                                        const menuElement = taskItem.querySelector('.task-popup-menu');
                                        const backdrop = document.getElementById('mobile-menu-backdrop');
                                        
                                        // 关闭所有其他打开的菜单
                                        document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                                            if (menu !== menuElement) {
                                                menu.classList.remove('show');
                                            }
                                        });
                                        
                                        // 切换当前菜单的显示状态
                                        menuElement.classList.toggle('show');
                                        
                                        // 移动端处理遮罩层
                                        if (window.innerWidth <= 768) {
                                            if (menuElement.classList.contains('show')) {
                                                backdrop.classList.add('show');
                                            } else {
                                                backdrop.classList.remove('show');
                                            }
                                        }
                                        
                                        // 根据按钮位置调整菜单位置
                                        positionPopupMenu(this, menuElement);
                                        
                                        // 阻止事件冒泡
                                        e.stopPropagation();
                                    }
                                });
                            }
                        } else {
                            // 如果找不到临时任务元素，重新加载整个列表
                            loadBirthdays();
                        }
                    } else {
                        // 如果没有返回数据，重新加载整个列表
                        loadBirthdays();
                    }
                    
                    return data;
                } catch (error) {
                    console.error('添加任务失败:', error);
                    // 移除临时添加的任务元素
                    const tempTask = document.querySelector(`[data-id="${tempId}"]`);
                    if (tempTask) {
                        tempTask.parentNode.removeChild(tempTask);
                    }
                    // 显示错误消息
                    alert('添加失败: ' + error.message);
                    return null;
                } finally {
                    // 始终移除待插入标记
                    window.pendingInsertTexts.delete(normalizedText);
                }
            } catch (error) {
                console.error('添加任务失败:', error);
                // 移除临时添加的任务元素
                const tempTask = document.querySelector(`[data-id="${tempId}"]`);
                if (tempTask) {
                    tempTask.parentNode.removeChild(tempTask);
                }
                // 显示错误消息
                alert('添加失败: ' + error.message);
                return null;
            }
        }

        // 修复创建空白可编辑任务的功能
        function createEmptyEditableTask() {
            console.log("创建新任务函数被调用");
            
            try {
                // 确保任务列表元素存在
                const taskList = document.getElementById('task-list');
                if (!taskList) {
                    console.error("找不到任务列表元素!");
                    return;
                }
                
                // 如果已经存在正在编辑的临时任务，先保存它再创建新任务
                if (window.currentEditingTempTask) {
                    console.log("已存在临时任务，尝试保存它然后创建新任务");
                    const existingTextElement = window.currentEditingTempTask.querySelector('.task-text');
                    if (existingTextElement) {
                        const existingText = htmlToPlainText(existingTextElement.innerHTML);
                        
                        // 保存现有任务引用，因为在异步操作中它可能会改变
                        const existingTaskItem = window.currentEditingTempTask;
                        
                        // 如果有内容则保存，否则直接移除
                        if (existingText && existingText.trim() !== '') {
                            // 标记为正在保存
                            existingTaskItem.dataset.saving = "true";
                            
                            // 显示保存中的状态
                            existingTextElement.contentEditable = "false";
                            existingTextElement.classList.remove('editing');
                            
                            // 立即重置全局变量，以便能创建新任务
                            window.currentEditingTempTask = null;
                            
                            // 异步保存现有任务
                            addTask(existingText).then(() => {
                                // 保存成功后移除旧任务元素
                                if (existingTaskItem && existingTaskItem.parentNode) {
                                    existingTaskItem.parentNode.removeChild(existingTaskItem);
                                }
                            }).catch(err => {
                                console.error("保存已存在的临时任务失败:", err);
                                // 如果保存失败，先移除再创建新的
                                if (existingTaskItem && existingTaskItem.parentNode) {
                                    existingTaskItem.parentNode.removeChild(existingTaskItem);
                                }
                            });
                        } else {
                            // 空任务直接移除
                            if (existingTaskItem && existingTaskItem.parentNode) {
                                existingTaskItem.parentNode.removeChild(existingTaskItem);
                            }
                            window.currentEditingTempTask = null;
                        }
                    } else {
                        // 如果找不到文本元素，直接清除状态
                        if (window.currentEditingTempTask.parentNode) {
                            window.currentEditingTempTask.parentNode.removeChild(window.currentEditingTempTask);
                        }
                        window.currentEditingTempTask = null;
                    }
                }

                // 使用一个标志来标识这是一个临时任务
                const tempFlag = 'new-task-' + Date.now();
                console.log("创建临时任务，ID:", tempFlag);
                
                // 创建新的任务项HTML元素
                const newTaskItem = document.createElement('li');
                newTaskItem.className = 'task-item temp-task';
                newTaskItem.dataset.id = tempFlag;
                newTaskItem.dataset.tempFlag = 'true';
                
                // 设置初始透明度
                newTaskItem.style.opacity = '0';
                newTaskItem.style.transition = 'opacity 0.3s ease';
                
                // 创建任务内容
                const taskContent = document.createElement('div');
                taskContent.className = 'task-content';
                
                // 创建复选框
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'task-checkbox';
                
                // 创建文本元素
                const textElement = document.createElement('span');
                textElement.className = 'task-text editing';
                textElement.contentEditable = 'true';
                
                // 创建更多按钮
                const moreButton = document.createElement('button');
                moreButton.className = 'info-task-btn';
                moreButton.tabIndex = '-1';
                moreButton.innerHTML = '<i class="bi bi-three-dots-vertical"></i>';
                
                // 创建弹出菜单
                const popupMenu = document.createElement('div');
                popupMenu.className = 'task-popup-menu';
                popupMenu.innerHTML = `
                    <div class="task-popup-menu-item view-info">
                        <i class="bi bi-info-circle"></i>创建于现在
                    </div>
                    <div class="task-popup-menu-item copy">
                        <i class="bi bi-clipboard"></i>复制
                    </div>
                    <div class="task-popup-menu-item delete">
                        <i class="bi bi-trash3"></i>删除
                    </div>
                `;
                
                // 组装DOM结构
                taskContent.appendChild(textElement);
                taskContent.appendChild(moreButton);
                taskContent.appendChild(popupMenu);
                newTaskItem.appendChild(checkbox);
                newTaskItem.appendChild(taskContent);
                
                // 清除可能存在的"载入中..."信息
                const emptyState = taskList.querySelector('.empty-state');
                if (emptyState) {
                    console.log("清除载入中状态");
                    taskList.innerHTML = '';
                }
                
                // 插入新任务到列表顶部
                console.log("插入新任务元素到列表顶部");
                if (taskList.firstChild) {
                    taskList.insertBefore(newTaskItem, taskList.firstChild);
                } else {
                    taskList.appendChild(newTaskItem);
                }
                
                // 滚动到新任务位置
                newTaskItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 标记全局状态
                window.currentEditingTempTask = newTaskItem;
                
                // 添加淡入效果
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        newTaskItem.style.opacity = '1';
                    });
                });
                
                // 使用 requestAnimationFrame 确保DOM更新后再设置焦点和选区
                requestAnimationFrame(() => {
                    textElement.focus();
                    
                    try {
                        // 确保元素在文档中
                        if (document.contains(textElement)) {
                            const range = document.createRange();
                            const selection = window.getSelection();
                            
                            // 设置范围为文本元素的内容
                            range.selectNodeContents(textElement);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                    } catch (err) {
                        console.error("设置文本选择范围失败:", err);
                    }
                });
                
                // 添加编辑事件处理
                textElement.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                        event.preventDefault();
                        console.log("按下Ctrl+Enter，保存任务");
                        finishTempTask(this);
                    } else if (event.key === 'Escape') {
                        event.preventDefault();
                        console.log("按下Escape，取消编辑");
                        removeTempTask(newTaskItem);
                        window.currentEditingTempTask = null;
                    }
                });
                
                // 失去焦点处理
                textElement.addEventListener('blur', function(event) {
                    setTimeout(() => {
                        if (document.contains(this) && window.currentEditingTempTask === newTaskItem) {
                            console.log("失去焦点，保存任务");
                            finishTempTask(this);
                        }
                    }, 200);
                });
                
            } catch (err) {
                console.error("创建任务失败:", err);
                alert("创建新任务失败，请刷新页面重试");
            }
        }

        // 处理临时任务的保存
        async function finishTempTask(textElement) {
            console.log("执行finishTempTask");
            
            // 如果文本元素不在DOM中，取消保存并重置状态
            if (!document.contains(textElement)) {
                console.log("元素已不在DOM中，取消保存");
                window.currentEditingTempTask = null; // 确保重置全局状态
                return;
            }
            
            const taskItem = textElement.closest('.task-item');
            if (!taskItem) {
                console.log("找不到关联的任务项，取消保存");
                window.currentEditingTempTask = null; // 确保重置全局状态
                return;
            }
            
            // 检查是否已经在保存过程中
            if (taskItem.dataset.saving === "true") {
                console.log("任务已经在保存中，避免重复保存");
                // 不做任何操作，让现有保存过程完成
                return;
            }
            
            // 获取文本内容
            const newText = htmlToPlainText(textElement.innerHTML);
            console.log("任务文本:", newText);
            
            // 保存一个任务项的引用，防止异步过程中丢失
            const taskRef = taskItem;
            
            // 立即标记为正在保存，防止重复保存
            taskRef.dataset.saving = "true";
            
            if (newText.trim() !== '') {
                try {
                    // 更新UI状态
                    textElement.contentEditable = "false";
                    textElement.classList.remove('editing');
                    
                    // 立即清除全局引用，允许创建新任务
                    if (window.currentEditingTempTask === taskRef) {
                        console.log("清除当前编辑任务引用，允许创建新任务");
                        window.currentEditingTempTask = null;
                    }
                    
                    // 调用添加任务API
                    console.log("调用addTask添加任务");
                    await addTask(newText);
                    
                    // 移除临时元素，数据会在addTask成功后重新加载
                    console.log("添加成功，移除临时元素");
                    if (taskRef && document.contains(taskRef) && taskRef.parentNode) {
                        // 添加淡出动画
                        taskRef.style.transition = 'opacity 0.3s ease';
                        taskRef.style.opacity = '0';
                        
                        // 等待动画完成后移除
                        setTimeout(() => {
                            if (taskRef && document.contains(taskRef) && taskRef.parentNode) {
                                taskRef.parentNode.removeChild(taskRef);
                            }
                        }, 300);
                    }
                } catch (err) {
                    console.error("添加任务时出错:", err);
                    
                    // 检查元素是否仍在文档中
                    if (document.contains(taskRef)) {
                        // 取消保存状态
                        taskRef.dataset.saving = "false";
                        
                        // 重新启用编辑功能
                        const recoveryTextElement = taskRef.querySelector('.task-text');
                        if (recoveryTextElement) {
                            recoveryTextElement.contentEditable = "true";
                            recoveryTextElement.classList.add('editing');
                            // 尝试重新获取焦点
                            try {
                                recoveryTextElement.focus();
                            } catch (focusErr) {
                                console.warn("重新获取焦点失败:", focusErr);
                            }
                        }
                        
                        // 恢复全局引用
                        if (!window.currentEditingTempTask) {
                            window.currentEditingTempTask = taskRef;
                        }
                    } else {
                        // 如果元素已不在文档中，确保全局状态是干净的
                        window.currentEditingTempTask = null;
                    }
                    
                    return; // 出错时提前返回
                }
            } else {
                // 如果任务为空，直接移除
                console.log("任务为空，移除临时元素");
                if (taskRef && document.contains(taskRef) && taskRef.parentNode) {
                    taskRef.parentNode.removeChild(taskRef);
                }
                
                // 确保重置全局状态
                if (window.currentEditingTempTask === taskRef) {
                    window.currentEditingTempTask = null;
                }
            }
        }

        // 移除临时任务元素
        function removeTempTask(taskItem) {
            console.log("执行removeTempTask，移除临时任务");
            
            // 检查任务项是否存在
            if (!taskItem) {
                console.log("任务项不存在，无需移除");
                return;
            }
            
            // 检查任务项是否仍在DOM中
            if (!document.contains(taskItem)) {
                console.log("任务项已不在DOM中，无需移除");
                // 仍然需要检查全局引用并清理
                if (window.currentEditingTempTask === taskItem) {
                    console.log("重置全局编辑任务引用");
                    window.currentEditingTempTask = null;
                }
                return;
            }
            
            // 如果已经在保存中，不再重复移除
            if (taskItem.dataset.saving === "true") {
                console.log("任务正在保存中，由保存过程处理移除");
                return;
            }
            
            // 移除DOM元素
            try {
                if (taskItem.parentNode) {
                    // 添加淡出动画
                    taskItem.style.transition = 'opacity 0.2s ease';
                    taskItem.style.opacity = '0';
                    
                    // 等待动画完成后移除
                    setTimeout(() => {
                        if (taskItem.parentNode) {
                            taskItem.parentNode.removeChild(taskItem);
                            console.log("成功从DOM中移除任务项");
                        }
                    }, 200);
                }
            } catch (err) {
                console.error("移除任务项时出错:", err);
            }
            
            // 检查并清除全局引用
            if (window.currentEditingTempTask === taskItem) {
                console.log("重置全局编辑任务引用");
                window.currentEditingTempTask = null;
            }
            
            // 检查是否有其他临时任务遗留
            const tempTasks = document.querySelectorAll('.task-item.temp-task');
            if (tempTasks.length > 0) {
                console.log(`发现 ${tempTasks.length} 个额外临时任务，也一并清理`);
                tempTasks.forEach(task => {
                    if (task !== taskItem && task.parentNode) {
                        try {
                            task.parentNode.removeChild(task);
                        } catch (err) {
                            console.warn("清理额外临时任务失败:", err);
                        }
                    }
                });
            }
        }

        // 在文档加载时初始化全局点击事件处理器
        function setupGlobalHandlers() {
            // 如果还没有添加过全局处理器，则添加
            if (!window.hasAddedGlobalTempTaskHandler) {
                console.log("添加全局临时任务处理器");
                window.hasAddedGlobalTempTaskHandler = true;
                
                document.addEventListener('click', function(event) {
                    if (!window.currentEditingTempTask) return;
                    
                    // 如果点击的不是临时任务或其子元素
                    if (!window.currentEditingTempTask.contains(event.target)) {
                        const textElement = window.currentEditingTempTask.querySelector('.task-text');
                        if (textElement) {
                            // 检查是否已经在保存过程中
                            if (window.currentEditingTempTask.dataset.saving === "true") {
                                console.log("任务已经在保存中，避免重复保存");
                                return;
                            }
                            
                            // 手动触发保存
                            const newText = htmlToPlainText(textElement.innerHTML);
                            if (newText !== '') {
                                // 标记为正在保存
                                window.currentEditingTempTask.dataset.saving = "true";
                                
                                // 将contentEditable设为false，防止在保存过程中继续编辑
                                textElement.contentEditable = "false";
                                textElement.classList.remove('editing');
                                
                                // 异步添加任务
                                addTask(htmlToPlainText(textElement.innerHTML)).then(() => {
                                    // 添加成功后移除临时任务
                                    if (window.currentEditingTempTask && window.currentEditingTempTask.parentNode) {
                                        window.currentEditingTempTask.parentNode.removeChild(window.currentEditingTempTask);
                                        window.currentEditingTempTask = null;
                                    }
                                }).catch(err => {
                                    console.error('点击其他区域保存任务失败:', err);
                                    // 取消保存状态
                                    if (window.currentEditingTempTask) {
                                        window.currentEditingTempTask.dataset.saving = "false";
                                        
                                        // 如果失败，回到编辑状态
                                        const textEl = window.currentEditingTempTask.querySelector('.task-text');
                                        if (textEl) {
                                            textEl.contentEditable = "true";
                                            textEl.classList.add('editing');
                                        }
                                    }
                                });
                            } else {
                                // 如果内容为空，直接移除临时任务
                                if (window.currentEditingTempTask && window.currentEditingTempTask.parentNode) {
                                    window.currentEditingTempTask.parentNode.removeChild(window.currentEditingTempTask);
                                }
                                
                                window.currentEditingTempTask = null;
                            }
                        }
                    }
                });
            }
        }

        async function toggleTaskStatus(id, isCompleted) {
            try {
                // 确保id是有效的
                if (!id || (typeof id === 'string' && (id.startsWith('temp-') || id.startsWith('new-task-')))) {
                    console.warn('尝试更新临时任务状态，已忽略');
                    return;
                }
                
                // 立即更新UI状态，不等待服务器响应
                const taskItem = document.querySelector(`.task-item[data-id="${id}"]`);
                if (taskItem) {
                    taskItem.classList.toggle('completed', isCompleted);
                }
                
                // 发送请求到服务器
                const { error } = await supabase
                    .from('todos')
                    .update({ is_completed: isCompleted })
                    .eq('id', id);
                
                if (error) {
                    throw error;
                }
            } catch (error) {
                console.error('更新任务状态失败:', error);
                
                // 如果出错，恢复UI状态
                const taskItem = document.querySelector(`.task-item[data-id="${id}"]`);
                if (taskItem) {
                    taskItem.classList.toggle('completed', !isCompleted);
                    const checkbox = taskItem.querySelector('.task-checkbox');
                    if (checkbox) {
                        checkbox.checked = !isCompleted;
                    }
                }
                
                // 显示错误消息
                alert(`更新失败: ${error.message || '服务器错误'}`);
            }
        }

        async function deleteTask(id) {
            try {
                const { error } = await supabase
                    .from('todos')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;

                showToast('任务已删除');

                // 检查当前是否应用了筛选
                if (window.currentFilterState === 'completed' || window.currentFilterState === 'uncompleted') {
                    // 如果有筛选，则重新加载并应用筛选，这样计数和空状态会更新
                    fetchAndFilterTasks(window.currentFilterState, true); // 添加第二个参数 true
                } else {
                    // 否则，直接从DOM中移除，并检查列表是否为空
                    const taskItem = document.querySelector(`.task-item[data-id="${id}"]`);
                    if (taskItem && taskItem.parentNode) {
                        // 应用淡出动画效果
                        taskItem.style.transition = 'opacity 0.3s ease';
                        taskItem.style.opacity = '0';
                        
                        // 等待动画完成后再从DOM移除
                        setTimeout(() => {
                            if (taskItem.parentNode) {
                                taskItem.parentNode.removeChild(taskItem);
                                
                                // 检查列表是否变为空
                                if (taskList.children.length === 0) {
                                    hideFilterStatus(); // 如果列表为空，也隐藏筛选状态
                                    taskList.innerHTML = '<div class="empty-state">列表为空，快来添加新任务吧！</div>';
                                }
                            }
                        }, 300);
                    } else {
                        // 如果DOM元素未找到，不重新加载整个列表，而只检查列表是否为空
                        if (taskList.children.length === 0) {
                            hideFilterStatus(); // 如果列表为空，也隐藏筛选状态
                            taskList.innerHTML = '<div class="empty-state">列表为空，快来添加新任务吧！</div>';
                        }
                    }
                }
            } catch (error) {
                console.error('删除任务失败:', error);
                alert('删除失败: ' + error.message);
            }
        }

        // 添加清除所有已完成任务的功能
        async function clearCompletedTasks() {
            try {
                // 获取所有已完成的任务ID
                const completedItems = document.querySelectorAll('.task-item.completed');
                if (completedItems.length === 0) {
                    alert('没有已完成的任务需要清除');
                    return;
                }
                
                // 显示加载状态
                document.body.style.cursor = 'wait';
                
                // 从数据库中删除所有已完成的任务
                const { error } = await supabase
                    .from('todos')
                    .delete()
                    .eq('is_completed', true);
                
                if (error) throw error;
                
                // 重新加载任务列表
                loadBirthdays();
                
                // 恢复正常光标
                document.body.style.cursor = 'default';
            } catch (error) {
                console.error('清除已完成任务失败:', error);
                alert('清除失败: ' + error.message);
                document.body.style.cursor = 'default';
            }
        }

        function getThemeFromIcon(iconElement) {
            if (!iconElement) return 'purple';
            return iconElement.classList.contains('blue') ? 'blue' :
                   iconElement.classList.contains('red') ? 'red' : 'purple';
        }

        // 压缩版本的updateThemeAndTitle函数修复
        function updateThemeAndTitle(e){
            const t=e.querySelector("span").textContent,
                  i=e.querySelector(".sidebar-icon"),
                  n=getThemeFromIcon(i);
            
            document.querySelector(".list-title").textContent=t;
            document.querySelector(".mobile-title").textContent=t;
            document.body.dataset.theme=n;
            
            document.querySelectorAll(".sidebar-item").forEach(e=>e.classList.remove("active"));
            e.classList.add("active");
            
            loadBirthdays();
            
            if(window.innerWidth<=768){
                document.querySelector(".sidebar").style.display="none";
                document.querySelector(".main-content").style.display="block";
                document.querySelector(".mobile-header").style.display="flex";
                document.querySelector(".mobile-back").style.visibility="visible";
                document.querySelector(".mobile-actions").style.display="flex";
            }
        }

        function initialize() {
            console.log("初始化应用...");
            setupTaskListeners();
            setupGlobalHandlers();
            
            // 初始化滚动条增强功能
            setupScrollEnhancement();
            
            // 绑定添加任务按钮事件
            console.log("开始绑定添加任务按钮事件");
            document.querySelectorAll('.add-task-btn').forEach(button => {
                console.log("找到添加任务按钮:", button);
                // 移除可能存在的旧事件处理程序
                button.removeAttribute('onclick');
                const newButton = button.cloneNode(true);
                if (button.parentNode) {
                    button.parentNode.replaceChild(newButton, button);
                }
                
                // 添加新的事件处理程序
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('添加任务按钮被点击 (initialize)');
                    createEmptyEditableTask();
                });
            });
            
            // 启用 Popover (重复调用以确保新元素也能用)
            const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            const popoverList = [...popoverTriggerList].map(popoverTriggerEl => {
                // 避免重复初始化，如果已有实例则跳过
                if (!bootstrap.Popover.getInstance(popoverTriggerEl)) {
                    return new bootstrap.Popover(popoverTriggerEl);
                }
                return null;
            }).filter(Boolean);
            
            const initialActiveItem = document.querySelector('.sidebar-item.active') || document.querySelector('.sidebar-item');
            if (initialActiveItem) {
                updateThemeAndTitle(initialActiveItem);
            } else {
                loadBirthdays();
            }

            // 全局点击事件处理
            document.addEventListener('click', function(e) {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && sidebar.style.display === 'flex' &&
                    !sidebar.contains(e.target) &&
                    !e.target.closest('.mobile-back') &&
                    window.innerWidth <= 768) {
                    sidebar.style.display = 'none';
                    document.querySelector('.main-content').style.display = 'block';
                    document.querySelector('.mobile-header').style.display = 'flex';
                }
            });

            // 移动端返回按钮
            document.querySelector('.mobile-back').addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    sidebar.style.display = 'flex';
                    document.querySelector('.main-content').style.display = 'none';
                    document.querySelector('.mobile-header').style.display = 'none';
                }
            });

            // 窗口大小调整
            window.addEventListener('resize', function() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const mobileHeader = document.querySelector('.mobile-header');

                if (window.innerWidth > 768) {
                    sidebar.style.display = '';
                    mainContent.style.display = '';
                    mobileHeader.style.display = 'none';
                } else if (sidebar.style.display !== 'flex') {
                    sidebar.style.display = 'none';
                    mainContent.style.display = 'block';
                    mobileHeader.style.display = 'flex';
                } else {
                    mainContent.style.display = 'none';
                    mobileHeader.style.display = 'none';
                }
            });

            // 移动端更多操作按钮
            document.querySelector('.mobile-actions .header-action:last-child').addEventListener('click', function() {
                const listTitle = document.querySelector('.mobile-title').textContent;
                if (listTitle === '列表') return;

                // 获取列表操作菜单
                const listMenu = document.getElementById('list-popup-menu');
                
                // 关闭所有其他打开的菜单
                document.querySelectorAll('.task-popup-menu.show, .sidebar-popup-menu.show, .list-popup-menu.show').forEach(menu => {
                    if (menu !== listMenu) {
                        menu.classList.remove('show');
                    }
                });
                
                // 切换菜单显示状态
                listMenu.classList.toggle('show');
                
                // 调整菜单位置
                positionListMenu(this, listMenu);
                
                // 阻止事件冒泡
                event.stopPropagation();
            });

            // PC端更多操作按钮
            document.querySelector('.header-actions .header-action:last-child').addEventListener('click', function() {
                const listTitle = document.querySelector('.list-title').textContent;
                
                // 获取列表操作菜单
                const listMenu = document.getElementById('list-popup-menu');
                
                // 关闭所有其他打开的菜单
                document.querySelectorAll('.task-popup-menu.show, .sidebar-popup-menu.show, .list-popup-menu.show').forEach(menu => {
                    if (menu !== listMenu) {
                        menu.classList.remove('show');
                    }
                });
                
                // 切换菜单显示状态
                listMenu.classList.toggle('show');
                
                // 调整菜单位置
                positionListMenu(this, listMenu);
                
                // 阻止事件冒泡
                event.stopPropagation();
            });

            // 侧边栏点击处理
            sidebarList.addEventListener("click", function(e) {
                const targetItem = e.target.closest(".sidebar-item");
                const targetMore = e.target.closest(".sidebar-more");
                
                // 处理菜单按钮点击
                if (targetMore) {
                    e.stopPropagation();
                    const listItem = targetMore.closest(".sidebar-item");
                    const menuElement = listItem.querySelector(".sidebar-popup-menu");
                    
                    // 关闭所有其他打开的菜单
                    document.querySelectorAll(".sidebar-popup-menu.show").forEach(menu => {
                        if (menu !== menuElement) {
                            menu.classList.remove("show");
                        }
                    });
                    
                    // 切换当前菜单的显示状态
                    menuElement.classList.toggle("show");
                    
                    // 根据按钮位置调整菜单位置
                    positionSidebarMenu(targetMore, menuElement);
                    
                    e.stopPropagation();
                } 
                // 处理菜单项点击
                else if (e.target.closest(".sidebar-popup-menu-item")) {
                    const menuItem = e.target.closest(".sidebar-popup-menu-item");
                    const listItem = menuItem.closest(".sidebar-item");
                    const listName = listItem.querySelector("span").textContent;
                    
                    // 编辑名称
                    if (menuItem.classList.contains("edit")) {
                        // 获取列表项和名称元素
                        const listSpan = listItem.querySelector("span");
                        
                        // 使名称可编辑
                        makeListNameEditable(listSpan, listName, listItem);
                    } 
                    // 删除列表
                    else if (menuItem.classList.contains("delete")) {
                        deleteList(listItem);
                    }
                    
                    // 关闭菜单
                    const menuElement = listItem.querySelector(".sidebar-popup-menu");
                    menuElement.classList.remove("show");
                    
                    e.stopPropagation();
                } 
                // 处理点击列表项本身
                else if (targetItem) {
                    // 立即更新主题和标题
                    updateThemeAndTitle(targetItem);
                }
            });
            
            // 添加双击列表名称编辑功能
            sidebarList.addEventListener('dblclick', function(e) {
                // 检查是否点击了列表名称
                if (e.target.tagName === 'SPAN' && e.target.parentNode.classList.contains('sidebar-item')) {
                    e.stopPropagation();
                    const listSpan = e.target;
                    const listItem = listSpan.closest('.sidebar-item');
                    const listName = listSpan.textContent;
                    
                    // 使名称可编辑
                    makeListNameEditable(listSpan, listName, listItem);
                }
            });
            
            // 将列表名称变为可编辑状态的函数
            function makeListNameEditable(listSpan, listName, listItem) {
                // 使名称可编辑
                listSpan.contentEditable = "true";
                listSpan.classList.add('editing');
                
                // 设置焦点到名称
                listSpan.focus();
                
                // 选中所有文本
                const range = document.createRange();
                range.selectNodeContents(listSpan);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // 为名称添加编辑相关事件
                // 按Enter或失去焦点时保存
                function saveListName() {
                    const newName = listSpan.textContent.trim();
                    
                    // 确保名称不为空
                    if (newName === '') {
                        listSpan.textContent = listName; // 恢复原名称
                    } else if (newName !== listName) {
                        // 更新名称
                        listSpan.textContent = newName;
                        
                        // 更新图标文字为新名称的第一个字符
                        const iconElement = listItem.querySelector('.sidebar-icon');
                        if (iconElement) {
                            iconElement.textContent = newName.charAt(0);
                        }
                        
                        // 如果是当前活动列表，更新标题
                        if (listItem.classList.contains('active')) {
                            document.querySelector('.list-title').textContent = newName;
                            document.querySelector('.mobile-title').textContent = newName;
                        }
                    }
                    
                    // 移除编辑状态
                    listSpan.contentEditable = "false";
                    listSpan.classList.remove('editing');
                    
                    // 移除事件监听器
                    listSpan.removeEventListener('keydown', handleKeyDown);
                    listSpan.removeEventListener('blur', saveListName);
                }
                
                // 处理键盘事件
                function handleKeyDown(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // 阻止插入换行
                        saveListName();
                        listSpan.blur(); // 移除焦点
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        listSpan.textContent = listName; // 恢复原名称
                        listSpan.contentEditable = "false";
                        listSpan.classList.remove('editing');
                        listSpan.blur();
                        
                        // 移除事件监听器
                        listSpan.removeEventListener('keydown', handleKeyDown);
                        listSpan.removeEventListener('blur', saveListName);
                    }
                }
                
                // 添加事件监听器
                listSpan.addEventListener('keydown', handleKeyDown);
                listSpan.addEventListener('blur', saveListName);
            }

            // 移除了全屏按钮相关代码
            
            /*
            // 进入全屏的标准JavaScript代码，仅供参考：
            function enterFullscreen(element) {
                if(element.requestFullscreen) {
                    element.requestFullscreen();
                } else if(element.msRequestFullscreen) {      // IE
                    element.msRequestFullscreen();
                } else if(element.webkitRequestFullscreen) {  // Safari
                    element.webkitRequestFullscreen();
                } else if(element.mozRequestFullscreen) {     // Firefox
                    element.mozRequestFullscreen();
                }
            }
            
            // 使用方法：enterFullscreen(document.documentElement); // 全屏整个页面
            */

            // 添加列表按钮点击事件
            document.querySelector('.sidebar-add').addEventListener('click', function() {
                // 创建颜色选择对话框
                const colorDialog = document.createElement('div');
                colorDialog.className = 'color-theme-dialog';
                colorDialog.innerHTML = `
                    <div class="color-dialog-content">
                        <h3>选择列表颜色</h3>
                        <div class="color-options">
                            <div class="color-option purple active" data-theme="purple">
                                <div class="color-circle"></div>
                                <div class="color-name">紫色</div>
                            </div>
                            <div class="color-option blue" data-theme="blue">
                                <div class="color-circle"></div>
                                <div class="color-name">蓝色</div>
                            </div>
                            <div class="color-option red" data-theme="red">
                                <div class="color-circle"></div>
                                <div class="color-name">红色</div>
                            </div>
                        </div>
                        <div class="color-dialog-buttons">
                            <button class="color-cancel-btn">取消</button>
                            <button class="color-confirm-btn">确定</button>
                        </div>
                    </div>
                `;
                
                // 添加样式
                const style = document.createElement('style');
                style.textContent = `
                    .color-theme-dialog {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 2000;
                    }
                    .color-dialog-content {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        width: 320px;
                        max-width: 90%;
                        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                    }
                    .color-dialog-content h3 {
                        margin: 0 0 20px 0;
                        font-size: 18px;
                        text-align: center;
                    }
                    .color-options {
                        display: flex;
                        justify-content: space-around;
                        margin-bottom: 25px;
                    }
                    .color-option {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 8px;
                        transition: background-color 0.2s;
                    }
                    .color-option:hover {
                        background-color: rgba(0, 0, 0, 0.05);
                    }
                    .color-option.active {
                        background-color: rgba(0, 0, 0, 0.1);
                    }
                    .color-circle {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        margin-bottom: 8px;
                    }
                    .color-option.purple .color-circle {
                        background-color: var(--theme-purple);
                    }
                    .color-option.blue .color-circle {
                        background-color: var(--theme-blue);
                    }
                    .color-option.red .color-circle {
                        background-color: var(--theme-red);
                    }
                    .color-name {
                        font-size: 14px;
                    }
                    .color-dialog-buttons {
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                    }
                    .color-dialog-buttons button {
                        padding: 8px 16px;
                        border-radius: 6px;
                        border: none;
                        font-size: 14px;
                        cursor: pointer;
                    }
                    .color-cancel-btn {
                        background-color: #f1f1f1;
                        color: #333;
                    }
                    .color-confirm-btn {
                        background-color: var(--primary-color);
                        color: white;
                    }
                `;
                document.head.appendChild(style);
                document.body.appendChild(colorDialog);
                
                // 添加颜色选项点击事件
                colorDialog.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', function() {
                        // 移除所有active类
                        colorDialog.querySelectorAll('.color-option').forEach(opt => {
                            opt.classList.remove('active');
                        });
                        // 添加active类到当前选中项
                        this.classList.add('active');
                    });
                });
                
                // 添加取消按钮点击事件
                colorDialog.querySelector('.color-cancel-btn').addEventListener('click', function() {
                    // 移除对话框
                    colorDialog.remove();
                    // 移除样式
                    style.remove();
                });
                
                // 添加确定按钮点击事件
                colorDialog.querySelector('.color-confirm-btn').addEventListener('click', function() {
                    // 获取选中的颜色主题
                    const selectedTheme = colorDialog.querySelector('.color-option.active').dataset.theme;
                    
                    // 创建新的列表项
                    const newItem = document.createElement('li');
                    newItem.className = 'sidebar-item';
                    newItem.innerHTML = `
                        <div class="sidebar-icon ${selectedTheme}">新</div>
                        <span class="editing" contenteditable="true">新列表</span>
                        <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                        <div class="sidebar-popup-menu">
                            <div class="sidebar-popup-menu-item edit">
                                <i class="bi bi-pencil"></i>编辑名称
                            </div>
                            <div class="sidebar-popup-menu-item delete">
                                <i class="bi bi-trash3"></i>删除列表
                            </div>
                        </div>
                    `;
                    
                    // 移除对话框
                    colorDialog.remove();
                    // 移除样式
                    style.remove();
                    
                    // 添加到列表中
                    const sidebarList = document.querySelector('.sidebar-list');
                    sidebarList.appendChild(newItem);
                    
                    // 获取名称元素并设置焦点
                    const listSpan = newItem.querySelector('span');
                    
                    // 设置焦点并选择所有文本
                    setTimeout(() => {
                        listSpan.focus();
                        
                        // 选中所有文本
                        const range = document.createRange();
                        range.selectNodeContents(listSpan);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        
                        // 为名称添加编辑相关事件
                        // 按Enter或失去焦点时保存
                        function saveNewListName() {
                            const listName = listSpan.textContent.trim();
                            
                            // 确保名称不为空
                            if (listName === '') {
                                // 如果为空，移除该列表项
                                if (newItem.parentNode) {
                                    newItem.parentNode.removeChild(newItem);
                                }
                                return;
                            }
                            
                            // 更新图标中的首字符
                            const firstChar = listName.charAt(0);
                            newItem.querySelector('.sidebar-icon').textContent = firstChar;
                            
                            // 移除编辑状态
                            listSpan.contentEditable = "false";
                            listSpan.classList.remove('editing');
                            
                            // 切换到新创建的列表
                            updateThemeAndTitle(newItem);
                            
                            // 移除事件监听器
                            listSpan.removeEventListener('keydown', handleKeyDown);
                            listSpan.removeEventListener('blur', saveNewListName);
                        }
                        
                        // 处理键盘事件
                        function handleKeyDown(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault(); // 阻止插入换行
                                saveNewListName();
                                listSpan.blur(); // 移除焦点
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                // 如果按ESC，取消创建
                                if (newItem.parentNode) {
                                    newItem.parentNode.removeChild(newItem);
                                }
                            }
                        }
                        
                        // 添加事件监听器
                        listSpan.addEventListener('keydown', handleKeyDown);
                        listSpan.addEventListener('blur', saveNewListName);
                    }, 50);
                });
            });

            // 点击文档其他地方关闭所有弹出菜单
            document.addEventListener('click', function(event) {
                // 关闭任务弹出菜单
                if (!event.target.closest('.info-task-btn') && !event.target.closest('.task-popup-menu')) {
                    document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
                
                // 关闭侧边栏弹出菜单
                if (!event.target.closest('.sidebar-more') && !event.target.closest('.sidebar-popup-menu')) {
                    document.querySelectorAll('.sidebar-popup-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
                
                // 关闭列表操作菜单
                if (!event.target.closest('.header-action:last-child') && !event.target.closest('.list-popup-menu')) {
                    document.querySelectorAll('.list-popup-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
            
            // 列表操作菜单项点击事件
            document.getElementById('list-popup-menu').addEventListener('click', function(event) {
                const menuItem = event.target.closest('.list-popup-menu-item');
                if (!menuItem) return;
                
                const action = menuItem.dataset.action;
                
                if (action === 'show-all') {
                    // 显示全部任务
                    loadBirthdays();
                } else if (action === 'show-completed-only') {
                    // 仅显示已完成任务 - 强制从服务器获取最新数据
                    fetchAndFilterTasks('completed');
                } else if (action === 'show-uncompleted-only') {
                    // 仅显示未完成任务 - 强制从服务器获取最新数据
                    fetchAndFilterTasks('uncompleted');
                }
                
                // 关闭菜单
                this.classList.remove('show');
            });
            
            // 从服务器获取数据并按条件筛选
            async function fetchAndFilterTasks(filterType, isDeletionOperation = false) {
                try {
                    // 显示加载中状态 - 仅当不是删除操作时
                    if (!isDeletionOperation) {
                        taskList.innerHTML = `<div class="empty-state">载入中...</div>`;
                    }
                    
                    // 从服务器获取所有任务
                    const { data, error } = await supabase
                        .from('todos')
                        .select('id, task, is_completed, created_at')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    // 根据筛选类型过滤任务
                    let filteredData;
                    if (filterType === 'completed') {
                        filteredData = data.filter(item => item.is_completed);
                    } else if (filterType === 'uncompleted') {
                        filteredData = data.filter(item => !item.is_completed);
                    } else {
                        // 如果 filterType 不是 'completed' 或 'uncompleted'，则显示全部
                        // 这种情况理论上不应该通过这个函数处理，loadBirthdays 会处理 "显示全部"
                        // 但为了健壮性，这里也处理一下
                        filteredData = data;
                        window.currentFilterState = null; // 清除筛选状态
                        hideFilterStatus();
                        renderTaskItems(filteredData, 'task', null, null);
                        if (filteredData.length === 0) {
                            taskList.innerHTML = '<div class="empty-state">列表为空，快来添加新任务吧！</div>';
                        }
                        return;
                    }
                    
                    // 设置筛选状态
                    window.currentFilterState = filterType;
                    
                    // 显示筛选状态提示
                    showFilterStatus(filteredData.length, filterType);
                    
                    // 渲染筛选后的任务
                    if (filteredData.length > 0) {
                        renderTaskItems(filteredData, 'task', null, null);
                    } else {
                         let emptyMessage = '没有符合筛选条件的任务';
                        if (filterType === 'completed') {
                            emptyMessage = '没有已完成的任务';
                        } else if (filterType === 'uncompleted') {
                            emptyMessage = '没有未完成的任务';
                        }
                        taskList.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
                    }
                } catch (error) {
                    console.error('筛选任务失败:', error);
                    taskList.innerHTML = `<div class="empty-state">筛选失败，请重试</div>`;
                    window.currentFilterState = null;
                    hideFilterStatus();
                }
            }
            
            // 添加窗口大小调整监听器，在调整大小时重新定位所有显示的菜单
            window.addEventListener('resize', function() {
                // 重新定位任务弹出菜单
                document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                    const taskItem = menu.closest('.task-item');
                    if (taskItem) {
                        const infoButton = taskItem.querySelector('.info-task-btn');
                        if (infoButton) {
                            positionPopupMenu(infoButton, menu);
                        }
                    }
                });
                
                // 重新定位侧边栏弹出菜单
                document.querySelectorAll('.sidebar-popup-menu.show').forEach(menu => {
                    const sidebarItem = menu.closest('.sidebar-item');
                    if (sidebarItem) {
                        const moreButton = sidebarItem.querySelector('.sidebar-more');
                        if (moreButton) {
                            positionSidebarMenu(moreButton, menu);
                        }
                    }
                });
            });
            
            // 遮罩层点击事件
            document.getElementById('mobile-menu-backdrop').addEventListener('click', function() {
                // 关闭所有打开的菜单
                document.querySelectorAll('.task-popup-menu.show, .sidebar-popup-menu.show, .list-popup-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
                // 隐藏遮罩层
                this.classList.remove('show');
            });
        }

        // 添加在document.addEventListener("DOMContentLoaded", function()...)代码之前的位置

        // 添加直接的事件绑定，确保列表切换功能正常工作
        document.addEventListener("DOMContentLoaded", function() {
            console.log("绑定侧边栏点击事件...");
            
            // 绑定添加任务按钮事件
            document.querySelectorAll('.add-task-btn').forEach(button => {
                console.log('DOM加载后：找到添加任务按钮', button);
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('添加任务按钮被点击');
                    createEmptyEditableTask();
                });
            });
            
            // 初始化列表操作菜单事件
            document.getElementById('list-popup-menu').addEventListener('click', function(event) {
                const menuItem = event.target.closest('.list-popup-menu-item');
                if (!menuItem) return;
                
                const action = menuItem.dataset.action;
                
                if (action === 'show-all') {
                    // 显示全部任务
                    loadBirthdays();
                } else if (action === 'show-completed-only') {
                    // 仅显示已完成任务 - 强制从服务器获取最新数据
                    fetchAndFilterTasks('completed');
                } else if (action === 'show-uncompleted-only') {
                    // 仅显示未完成任务 - 强制从服务器获取最新数据
                    fetchAndFilterTasks('uncompleted');
                }
                
                // 关闭菜单
                this.classList.remove('show');
            });
            
            // 从服务器获取数据并按条件筛选
            async function fetchAndFilterTasks(filterType, isDeletionOperation = false) {
                try {
                    // 显示加载中状态 - 仅当不是删除操作时
                    if (!isDeletionOperation) {
                        taskList.innerHTML = `<div class="empty-state">载入中...</div>`;
                    }
                    
                    // 从服务器获取所有任务
                    const { data, error } = await supabase
                        .from('todos')
                        .select('id, task, is_completed, created_at')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    // 根据筛选类型过滤任务
                    let filteredData;
                    if (filterType === 'completed') {
                        filteredData = data.filter(item => item.is_completed);
                    } else if (filterType === 'uncompleted') {
                        filteredData = data.filter(item => !item.is_completed);
                    } else {
                        // 如果 filterType 不是 'completed' 或 'uncompleted'，则显示全部
                        // 这种情况理论上不应该通过这个函数处理，loadBirthdays 会处理 "显示全部"
                        // 但为了健壮性，这里也处理一下
                        filteredData = data;
                        window.currentFilterState = null; // 清除筛选状态
                        hideFilterStatus();
                        renderTaskItems(filteredData, 'task', null, null);
                        if (filteredData.length === 0) {
                            taskList.innerHTML = '<div class="empty-state">列表为空，快来添加新任务吧！</div>';
                        }
                        return;
                    }
                    
                    // 设置筛选状态
                    window.currentFilterState = filterType;
                    
                    // 显示筛选状态提示
                    showFilterStatus(filteredData.length, filterType);
                    
                    // 渲染筛选后的任务
                    if (filteredData.length > 0) {
                        renderTaskItems(filteredData, 'task', null, null);
                    } else {
                         let emptyMessage = '没有符合筛选条件的任务';
                        if (filterType === 'completed') {
                            emptyMessage = '没有已完成的任务';
                        } else if (filterType === 'uncompleted') {
                            emptyMessage = '没有未完成的任务';
                        }
                        taskList.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
                    }
                } catch (error) {
                    console.error('筛选任务失败:', error);
                    taskList.innerHTML = `<div class="empty-state">筛选失败，请重试</div>`;
                    window.currentFilterState = null;
                    hideFilterStatus();
                }
            }
            
            // 为每个侧边栏项添加直接点击事件
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // 如果不是点击菜单按钮或菜单项，切换到该列表
                    if (!e.target.closest('.sidebar-more') && !e.target.closest('.sidebar-popup-menu-item')) {
                        console.log("列表项被点击:", this.querySelector('span').textContent);
                        updateThemeAndTitle(this);
                        e.stopPropagation();
                    }
                });
            });
            
            // 添加移动端返回按钮点击事件
            document.querySelector('.mobile-back').addEventListener('click', function() {
                console.log("返回按钮被点击");
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    sidebar.style.display = 'flex';
                    document.querySelector('.main-content').style.display = 'none';
                    document.querySelector('.mobile-header').style.display = 'none';
                }
            });
            
            // 初始化其他功能
            loadBirthdays();
            setupRealtime();
            initialize(); // 确保调用initialize函数进行完整初始化
        });

        function setupRealtime() {
            supabase
              .channel('public:todos')
              .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'todos' },
                payload => {
                  handleRealtimeChange(payload);
                }
              )
              .subscribe();
        }

        function handleRealtimeChange(payload) {
            const { eventType, new: newRow, old: oldRow } = payload;
            if (eventType === 'INSERT') {
                if (!insertTaskToDOM(newRow)) {
                    loadBirthdays(); // fallback
                }
            } else if (eventType === 'UPDATE') {
                if (!updateTaskInDOM(newRow)) {
                    loadBirthdays(); // fallback
                }
            } else if (eventType === 'DELETE') {
                if (!removeTaskFromDOM(oldRow.id)) {
                    loadBirthdays(); // fallback
                }
            }
        }

        // 插入新任务到DOM，已存在则不插入，返回true/false
        function insertTaskToDOM(task) {
            // 优先检查是否存在待同步的临时元素（通过文本匹配）
            const pendingItem = Array.from(document.querySelectorAll('.task-item.pending-sync')).find(li => {
                const txt = li.querySelector('.task-text');
                return txt && txt.textContent.trim() === (task.task || '').trim();
            });
            if (pendingItem) {
                // 复用该元素而不是新建
                pendingItem.dataset.id = task.id;
                pendingItem.classList.remove('pending-sync');
                delete pendingItem.dataset.pendingSync;
                // 更新复选框状态和值
                const chk = pendingItem.querySelector('.task-checkbox');
                if (chk) chk.checked = !!task.is_completed;
                const txtEl = pendingItem.querySelector('.task-text');
                if (txtEl) txtEl.innerHTML = (task.task || '').replace(/\n/g, '<br>');
                
                // 确保菜单功能正常
                ensureTaskMenuFunctionality(pendingItem);
                setupTaskListeners();
                return true;
            }
            // 若页面已存在相同 ID，则不插入
            if (document.querySelector(`.task-item[data-id="${task.id}"]`)) return true;
            const taskListElem = document.getElementById('task-list');
            if (!taskListElem) return false;
            const temp = document.createElement('div');
            temp.innerHTML = renderTaskItemHTML(task);
            const newTaskItem = temp.firstChild;
            
            // 先设置透明度为0
            newTaskItem.style.opacity = '0';
            newTaskItem.style.transition = 'opacity 0.3s ease';
            
            // 插入DOM
            if (taskListElem.firstChild) {
                taskListElem.insertBefore(newTaskItem, taskListElem.firstChild);
            } else {
                taskListElem.appendChild(newTaskItem);
            }
            
            // 检查是否需要移除空状态提示
            const emptyState = taskListElem.querySelector('.empty-state');
            if (emptyState) {
                emptyState.parentNode.removeChild(emptyState);
            }
            
            // 确保菜单功能正常
            ensureTaskMenuFunctionality(newTaskItem);
            setupTaskListeners();
            
            // 使用requestAnimationFrame确保DOM更新后再应用动画
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    newTaskItem.style.opacity = '1';
                });
            });
            
            return true;
        }

        // 更新任务内容到DOM，找不到则返回false
        function updateTaskInDOM(task) {
            const li = document.querySelector(`.task-item[data-id="${task.id}"]`);
            if (!li) return false;
            
            // 创建新HTML
            const newHTML = renderTaskItemHTML(task);
            const temp = document.createElement('div');
            temp.innerHTML = newHTML;
            const newLi = temp.firstChild;
            
            // 保存当前滚动位置
            const scrollPos = { 
                top: li.parentNode ? li.parentNode.scrollTop : 0,
                left: li.parentNode ? li.parentNode.scrollLeft : 0 
            };
            
            // 应用淡入淡出过渡
            li.style.transition = 'opacity 0.15s ease';
            li.style.opacity = '0.5';
            
            // 短时间后更新内容并恢复透明度
            setTimeout(() => {
                // 更新内容
                li.innerHTML = newLi.innerHTML;
                
                // 恢复透明度
                li.style.opacity = '1';
                
                // 恢复滚动位置
                if (li.parentNode) {
                    li.parentNode.scrollTop = scrollPos.top;
                    li.parentNode.scrollLeft = scrollPos.left;
                }
                
                // 确保菜单功能正常
                ensureTaskMenuFunctionality(li);
                setupTaskListeners();
            }, 50);
            
            return true;
        }

        // 从DOM中移除任务，找不到则返回false
        function removeTaskFromDOM(id) {
            const li = document.querySelector(`.task-item[data-id="${id}"]`);
            if (!li) return false;
            
            // 添加淡出动画效果
            li.style.transition = 'opacity 0.3s ease';
            li.style.opacity = '0';
            
            // 等待动画完成后再从DOM移除
            setTimeout(() => {
                if (li.parentNode) {
                    li.parentNode.removeChild(li);
                    
                    // 检查列表是否变为空
                    const taskList = document.getElementById('task-list');
                    if (taskList && taskList.children.length === 0) {
                        hideFilterStatus(); // 如果列表为空，也隐藏筛选状态
                        taskList.innerHTML = '<div class="empty-state">列表为空，快来添加新任务吧！</div>';
                    }
                }
            }, 300);
            
            return true;
        }

        // 渲染单个任务的HTML
        function renderTaskItemHTML(item) {
            let creationTime = '未知';
            if (item.created_at) {
                try {
                    creationTime = new Date(item.created_at).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                } catch (e) {}
            }
            return `<li class="task-item${item.is_completed ? ' completed' : ''}" data-id="${item.id}">
<input type="checkbox" class="task-checkbox" ${item.is_completed ? 'checked' : ''}>
<div class="task-content">
    <span class="task-text" contenteditable="false">${(item.task || '').replace(/\n/g, '<br>')}</span>
    ${item.note ? `<div class="task-note">${item.note}</div>` : ''}
    <button class="info-task-btn" tabindex="-1" data-created-at="${item.created_at || ''}"><i class="bi bi-three-dots-vertical"></i></button>
    <div class="task-popup-menu">
        <div class="task-popup-menu-item view-info">
            <i class="bi bi-info-circle"></i>创建: ${creationTime}
        </div>
        <div class="task-popup-menu-item copy">
            <i class="bi bi-clipboard"></i>复制
        </div>
        <div class="task-popup-menu-item delete">
            <i class="bi bi-trash3"></i>删除
        </div>
    </div>
</div>
</li>`;
        }
        
        // 确保任务菜单交互正常
        function ensureTaskMenuFunctionality(taskItem) {
            if (!taskItem) return;
            
            // 1. 菜单按钮点击事件
            const infoBtn = taskItem.querySelector('.info-task-btn');
            if (infoBtn) {
                // 移除可能存在的旧事件监听器
                const newInfoBtn = infoBtn.cloneNode(true);
                if (infoBtn.parentNode) {
                    infoBtn.parentNode.replaceChild(newInfoBtn, infoBtn);
                }
                
                // 添加新的事件监听器
                newInfoBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 防止事件冒泡
                    
                    const taskItem = this.closest('.task-item');
                    if (!taskItem) return;
                    
                    const menuElement = taskItem.querySelector('.task-popup-menu');
                    if (!menuElement) return;
                    
                    const backdrop = document.getElementById('mobile-menu-backdrop');
                    
                    // 关闭所有其他打开的菜单
                    document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                        if (menu !== menuElement) {
                            menu.classList.remove('show');
                        }
                    });
                    
                    // 切换当前菜单的显示状态
                    menuElement.classList.toggle('show');
                    
                    // 移动端处理遮罩层
                    if (window.innerWidth <= 768) {
                        if (menuElement.classList.contains('show')) {
                            backdrop.classList.add('show');
                        } else {
                            backdrop.classList.remove('show');
                        }
                    }
                    
                    // 根据按钮位置调整菜单位置
                    positionPopupMenu(this, menuElement);
                });
            }
            
            // 2. 菜单项点击事件
            const menuElement = taskItem.querySelector('.task-popup-menu');
            if (menuElement) {
                // 删除选项
                const deleteItem = menuElement.querySelector('.task-popup-menu-item.delete');
                if (deleteItem) {
                    // 移除可能存在的旧事件监听器
                    const newDeleteItem = deleteItem.cloneNode(true);
                    if (deleteItem.parentNode) {
                        deleteItem.parentNode.replaceChild(newDeleteItem, deleteItem);
                    }
                    
                    // 添加新的事件监听器
                    newDeleteItem.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        const taskItem = this.closest('.task-item');
                        if (!taskItem) return;
                        
                        const taskId = taskItem.dataset.id;
                        
                        // 使用自定义对话框删除任务
                        showCustomConfirm(
                            '删除任务？', 
                            '此任务将被永久删除', 
                            () => deleteTask(taskId)
                        );
                        
                        // 关闭菜单
                        menuElement.classList.remove('show');
                        
                        // 隐藏遮罩层
                        document.getElementById('mobile-menu-backdrop').classList.remove('show');
                    });
                }
                
                // 复制选项
                const copyItem = menuElement.querySelector('.task-popup-menu-item.copy');
                if (copyItem) {
                    // 移除可能存在的旧事件监听器
                    const newCopyItem = copyItem.cloneNode(true);
                    if (copyItem.parentNode) {
                        copyItem.parentNode.replaceChild(newCopyItem, copyItem);
                    }
                    
                    // 添加新的事件监听器
                    newCopyItem.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        const taskItem = this.closest('.task-item');
                        if (!taskItem) return;
                        
                        const taskText = taskItem.querySelector('.task-text').textContent;
                        copyToClipboard(taskText);
                        
                        // 显示一个小提示，表明已复制
                        showToast('已复制到剪贴板');
                        
                        // 关闭菜单
                        menuElement.classList.remove('show');
                        
                        // 隐藏遮罩层
                        document.getElementById('mobile-menu-backdrop').classList.remove('show');
                    });
                }
            }
            
            return taskItem;
        }
        
        // 自定义确认对话框函数
        function showCustomConfirm(title, message, okCallback) {
            const confirmDialog = document.getElementById('custom-confirm');
            const titleElement = document.getElementById('confirm-title');
            const messageElement = document.getElementById('confirm-message');
            const cancelButton = document.getElementById('confirm-cancel');
            const okButton = document.getElementById('confirm-ok');
            
            // 设置对话框内容
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // 立即显示对话框，没有动画
            confirmDialog.style.display = 'flex';
            
            // 绑定取消按钮事件
            const cancelHandler = () => {
                // 立即隐藏对话框，没有动画
                confirmDialog.style.display = 'none';
                
                cancelButton.removeEventListener('click', cancelHandler);
                okButton.removeEventListener('click', okHandler);
            };
            
            // 绑定确认按钮事件
            const okHandler = () => {
                // 立即隐藏对话框，没有动画
                confirmDialog.style.display = 'none';
                okCallback();
                
                cancelButton.removeEventListener('click', cancelHandler);
                okButton.removeEventListener('click', okHandler);
            };
            
            // 设置事件监听
            cancelButton.addEventListener('click', cancelHandler);
            okButton.addEventListener('click', okHandler);
            
            // 添加点击背景关闭对话框的功能
            const backdropClickHandler = (event) => {
                // 只有点击背景时才关闭
                if (event.target === confirmDialog) {
                    cancelHandler();
                }
            };
            
            confirmDialog.addEventListener('click', backdropClickHandler);
            
            // 一次性事件移除
            cancelButton.addEventListener('click', () => {
                confirmDialog.removeEventListener('click', backdropClickHandler);
            }, { once: true });
            
            okButton.addEventListener('click', () => {
                confirmDialog.removeEventListener('click', backdropClickHandler);
            }, { once: true });
        }
        
        // 列表删除功能
        function deleteList(listItem) {
            // 如果尝试删除最后一个列表项，显示提示并阻止删除
            const totalLists = document.querySelectorAll('.sidebar-item').length;
            if (totalLists <= 1) {
                showToast('无法删除最后一个列表');
                return;
            }
            
            // 获取列表名称
            const listName = listItem.querySelector('span').textContent;
            
            // 显示自定义确认对话框
            showCustomConfirm(
                `删除列表"${listName}"？`, 
                '此操作将删除列表中的所有提醒事项。', 
                () => {
                    // 如果删除的是当前激活的列表，切换到另一个列表
                    if (listItem.classList.contains('active')) {
                        // 查找下一个或上一个列表项
                        const nextItem = listItem.nextElementSibling;
                        const prevItem = listItem.previousElementSibling;
                        
                        // 优先选择下一个列表，如果没有则选择上一个
                        const newActiveItem = nextItem && nextItem.classList.contains('sidebar-item') ? 
                                            nextItem : 
                                            (prevItem && prevItem.classList.contains('sidebar-item') ? prevItem : null);
                        
                        if (newActiveItem) {
                            // 在删除后切换到新的列表
                            setTimeout(() => updateThemeAndTitle(newActiveItem), 0);
                        }
                    }
                    
                    // 从DOM中移除列表项
                    if (listItem.parentNode) {
                        listItem.parentNode.removeChild(listItem);
                    }
                    
                    // 显示成功提示
                    showToast('列表已删除');
                }
            );
        }

        // 确保全局函数在window对象上可用
        window.toggleTaskStatus = toggleTaskStatus;
        window.deleteTask = deleteTask;
        window.addTask = addTask;
        window.clearCompletedTasks = clearCompletedTasks;
        window.createEmptyEditableTask = createEmptyEditableTask;
        window.deleteList = deleteList;
        window.showCustomConfirm = showCustomConfirm;
        
        // 添加复制到剪贴板的功能
        function copyToClipboard(text) {
            // 创建一个临时的textarea元素
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';  // 避免滚动到底部
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                // 尝试复制
                document.execCommand('copy');
                console.log('文本已复制到剪贴板');
            } catch (err) {
                console.error('复制失败:', err);
            }
            
            // 清理
            document.body.removeChild(textarea);
        }
        
        // 显示提示消息
        function showToast(message, duration = 2000) {
            // 移除现有的toast
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                document.body.removeChild(existingToast);
            }
            
            // 创建新的toast
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // 指定时间后隐藏toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // 启用任务编辑功能
        function enableTaskEditing(textElement) {
            // 设置为可编辑状态
            textElement.contentEditable = "true";
            textElement.classList.add('editing');
            textElement.focus();
            
            // 添加编辑提示（如果还没有）
            if (!textElement.getAttribute('data-tooltip')) {
                textElement.setAttribute('data-tooltip', '按Ctrl+Enter完成编辑');
                textElement.title = '按回车换行，按Ctrl+Enter完成编辑';
            }
        }

        // 工具函数：将HTML内容统一转为\n换行
        function htmlToPlainText(html) {
            if (!html) return '';
            // 1. 将 <div>、<p> 替换为换行
            let text = html.replace(/<div><br><\/div>/gi, '\n')
                           .replace(/<div>/gi, '\n')
                           .replace(/<\/div>/gi, '')
                           .replace(/<p>/gi, '\n')
                           .replace(/<\/p>/gi, '')
                           .replace(/<br\s*\/?>(?!\n)/gi, '\n');
            // 2. 去除多余的换行
            text = text.replace(/^\n+|\n+$/g, '');
            // 3. 转义HTML实体
            const temp = document.createElement('div');
            temp.innerHTML = text;
            return temp.textContent || temp.innerText || '';
        }

        // 全局事件委托，确保添加任务按钮点击能被处理
        document.addEventListener('click', function(e) {
            const addTaskBtn = e.target.closest('.add-task-btn');
            if (addTaskBtn) {
                console.log('通过全局事件委托处理添加任务按钮点击', new Date().toISOString());
                console.log('当前临时任务状态:', window.currentEditingTempTask ? '存在' : '不存在');
                
                // 如果已经存在临时任务，尝试保存它
                if (window.currentEditingTempTask) {
                    const existingTextElement = window.currentEditingTempTask.querySelector('.task-text');
                    if (existingTextElement) {
                        const existingText = htmlToPlainText(existingTextElement.innerHTML);
                        
                        // 保存现有任务引用
                        const existingTaskItem = window.currentEditingTempTask;
                        
                        // 如果有内容则保存，否则直接移除
                        if (existingText && existingText.trim() !== '') {
                            console.log('保存现有临时任务:', existingText);
                            
                            // 标记为正在保存
                            existingTaskItem.dataset.saving = "true";
                            
                            // 显示保存中的状态
                            existingTextElement.contentEditable = "false";
                            existingTextElement.classList.remove('editing');
                            
                            // 立即重置全局变量，以便能创建新任务
                            window.currentEditingTempTask = null;
                            
                            // 异步保存现有任务，但不等待结果就创建新任务
                            addTask(existingText).then(() => {
                                // 保存成功后移除旧任务元素
                                if (existingTaskItem && existingTaskItem.parentNode) {
                                    existingTaskItem.parentNode.removeChild(existingTaskItem);
                                }
                            }).catch(err => {
                                console.error("保存已存在的临时任务失败:", err);
                                // 如果保存失败，先移除再创建新的
                                if (existingTaskItem && existingTaskItem.parentNode) {
                                    existingTaskItem.parentNode.removeChild(existingTaskItem);
                                }
                            });
                        } else {
                            // 空任务直接移除
                            if (existingTaskItem && existingTaskItem.parentNode) {
                                existingTaskItem.parentNode.removeChild(existingTaskItem);
                            }
                            window.currentEditingTempTask = null;
                        }
                    } else {
                        // 如果找不到文本元素，直接清除状态
                        const tempTasks = document.querySelectorAll('.task-item.temp-task');
                        tempTasks.forEach(task => {
                            console.log('移除发现的临时任务元素');
                            if (task.parentNode) task.parentNode.removeChild(task);
                        });
                        
                        window.currentEditingTempTask = null;
                    }
                }
                
                e.preventDefault();
                e.stopPropagation();
                createEmptyEditableTask();
            }
        });

        // 添加全局点击事件处理
        document.addEventListener('click', function(e) {
            // 关闭任务弹出菜单
            if (!e.target.closest('.info-task-btn') && !e.target.closest('.task-popup-menu')) {
                document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
            
            // 关闭侧边栏弹出菜单
            if (!e.target.closest('.sidebar-more') && !e.target.closest('.sidebar-popup-menu')) {
                document.querySelectorAll('.sidebar-popup-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
            
            // 关闭列表操作菜单
            if (!e.target.closest('.header-action:last-child') && !e.target.closest('.list-popup-menu')) {
                document.querySelectorAll('.list-popup-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
        
        // 滚动条增强功能
        function setupScrollEnhancement() {
            const scrollableElements = [
                document.querySelector('.sidebar-list'),
                document.querySelector('.main-content'),
                document.querySelector('.task-list')
            ].filter(el => el); // 过滤掉可能为null的元素
            
            // 检测是否为移动设备
            const isMobileDevice = window.matchMedia('(hover: none), (pointer: coarse)').matches;
            
            // 为所有可滚动元素添加滚动事件处理
            scrollableElements.forEach(el => {
                if (isMobileDevice) {
                    el.classList.add('scrolling-active');
                }
                
                // 添加滚动事件处理
                let scrollTimer;
                el.addEventListener('scroll', function() {
                    // 添加滚动中标记
                    this.classList.add('is-scrolling');
                    
                    // 清除之前的定时器
                    clearTimeout(scrollTimer);
                    
                    // 设置新的定时器，滚动停止后移除标记
                    scrollTimer = setTimeout(() => {
                        this.classList.remove('is-scrolling');
                    }, 1000); // 滚动停止1秒后隐藏滚动条或指示器
                });
                
                // 初始加载时触发一次滚动事件，显示滚动条
                if (el.scrollHeight > el.clientHeight) {
                    el.classList.add('is-scrolling');
                    clearTimeout(scrollTimer);
                    scrollTimer = setTimeout(() => {
                        el.classList.remove('is-scrolling');
                    }, 2000); // 初始显示2秒后隐藏
                }
            });
        }
        
        // 在初始化函数中调用滚动增强功能
        setupScrollEnhancement();
    </script>
</body>
</html> 


                    