<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日清单</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
:root{--bg-color:#fff;--sidebar-bg:#fff;--sidebar-hover:#f4f4f5;--sidebar-active:rgba(10,132,255,.2);--sidebar-text:#555;--sidebar-active-text:#000;--primary-color:#007aff;--primary-hover:#0062cc;--text-color:#1d1d1f;--secondary-text:#86868b;--border-color:rgba(0,0,0,.1);--shadow-sm:0 1px 2px rgba(0,0,0,.05);--theme-purple:#bf5af2;--theme-blue:#0a84ff;--theme-red:#ff453a;--current-theme-color:var(--theme-purple);--current-theme-hover-bg:rgba(191,90,242,.1);--divider-color:rgba(0,0,0,.15);--mobile-divider-color:#d0d0d0}body[data-theme=purple]{--current-theme-color:var(--theme-purple);--current-theme-hover-bg:rgba(191,90,242,.1)}body[data-theme=blue]{--current-theme-color:var(--theme-blue);--current-theme-hover-bg:rgba(10,132,255,.1)}body[data-theme=red]{--current-theme-color:var(--theme-red);--current-theme-hover-bg:rgba(255,69,58,.1)}@font-face{font-family:'SF Pro Text';src:local('SF Pro Text'),local('SFProText-Regular');font-weight:400}@font-face{font-family:'SF Pro Display';src:local('SF Pro Display'),local('SFProDisplay-Regular');font-weight:400}body{background-color:var(--bg-color);font-family:'SF Pro Text',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:var(--text-color);margin:0;padding:0;height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;scrollbar-width:thin;scrollbar-color:transparent transparent}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.2);border-radius:4px;border:2px solid transparent}::-webkit-scrollbar-thumb:hover{background-color:rgba(0,0,0,.3)}.sidebar-list,.main-content,.task-list{-webkit-overflow-scrolling:touch;scroll-behavior:smooth}@media (hover:hover) and (pointer:fine){.sidebar-list,.main-content,.task-list{scrollbar-width:thin;scrollbar-color:transparent transparent;transition:scrollbar-color .3s ease}.sidebar-list::-webkit-scrollbar-thumb,.main-content::-webkit-scrollbar-thumb,.task-list::-webkit-scrollbar-thumb{background-color:transparent;transition:background-color .3s ease}.sidebar-list:hover,.main-content:hover,.task-list:hover{scrollbar-color:rgba(0,0,0,.2) transparent}.sidebar-list:hover::-webkit-scrollbar-thumb,.main-content:hover::-webkit-scrollbar-thumb,.task-list:hover::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.2)}}@media (hover:none) or (pointer:coarse){.sidebar-list,.main-content,.task-list{scrollbar-width:thin;scrollbar-color:rgba(0,0,0,.1) transparent}.sidebar-list::-webkit-scrollbar-thumb,.main-content::-webkit-scrollbar-thumb,.task-list::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.1)}}.app-container{display:flex;height:100vh;width:100%;overflow-x:hidden}.sidebar{width:220px;background-color:var(--sidebar-bg);border-right:1px solid var(--border-color);height:100%;position:fixed;left:0;top:0;z-index:10;display:flex;flex-direction:column}.sidebar-list{margin:0;padding:10px 0;list-style:none;overflow-y:auto;flex-grow:1}.sidebar-item{padding:8px 15px;margin:4px 5px;border-radius:8px;cursor:pointer;display:flex;align-items:center;height:40px;font-size:.93rem;color:var(--text-color);position:relative}.sidebar-item:hover{background-color:var(--sidebar-hover)}.sidebar-item.active{background-color:var(--sidebar-active);color:var(--sidebar-active-text);font-weight:500}.sidebar-icon{display:flex;align-items:center;justify-content:center;width:25px;height:25px;border-radius:50%;margin-right:15px;font-size:.8rem;color:#fff;line-height:1}.sidebar-icon.purple{background-color:var(--theme-purple)}.sidebar-icon.blue{background-color:var(--theme-blue)}.sidebar-icon.red{background-color:var(--theme-red)}.sidebar-add{padding:15px;border-top:1px solid var(--border-color);color:var(--theme-blue);display:flex;align-items:center;cursor:pointer}.sidebar-add:hover{background-color:rgba(10,132,255,.1)}.sidebar-add i,.sidebar-more i{display:flex;align-items:center;justify-content:center;line-height:1}.sidebar-add i{margin-right:15px;font-size:1rem;color:var(--primary-color);width:25px;height:25px}.sidebar-add span{font-size:1rem;color:var(--primary-color)}.sidebar-more{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--secondary-text);cursor:pointer;opacity:0;font-size:.9rem;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;transition:opacity .15s ease-in-out}.sidebar-item:hover .sidebar-more{opacity:1}.sidebar-more:hover{background-color:rgba(0,0,0,.08)}.main-content{flex:1;padding:15px 0;margin-left:220px;height:100%;overflow-y:auto;overflow-x:hidden;box-sizing:border-box;width:calc(100% - 220px)}.content-inner{padding:0;max-width:none;width:100%;position:relative}.list-header{margin-bottom:15px;padding:0 20px 10px;border-bottom:1px solid var(--border-color);position:relative;display:flex;justify-content:space-between;align-items:center}.list-title{font-size:1.8rem;font-weight:600;margin-bottom:5px;font-family:'SF Pro Display',-apple-system,sans-serif;color:var(--current-theme-color)}.task-list{list-style:none;padding:0 20px;margin:0;width:100%;box-sizing:border-box;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:transparent transparent;transition:scrollbar-color .3s ease}.task-item{display:flex;align-items:center;padding:12px 0;position:relative;width:100%;box-sizing:border-box;margin:0}.task-content{display:flex;flex-direction:column;flex:1;margin-left:15px;position:relative;overflow:visible}.task-item::after{content:'';position:absolute;left:0;bottom:0;height:1px;background-color:var(--divider-color);width:100%;box-sizing:content-box;padding-left:20px;margin-left:-20px;right:auto}.task-item:last-child::after{display:none}.task-checkbox{position:relative;width:20px;height:20px;border-radius:50%;margin-left:15px;margin-right:5px;appearance:none;border:2px solid #c7c7cc;outline:none;cursor:pointer;flex-shrink:0;background-color:#fff}.task-checkbox:hover{border-color:var(--current-theme-color);background-color:var(--current-theme-hover-bg)}.task-checkbox:checked{border-color:var(--current-theme-color)}.task-checkbox:checked::after{content:'';position:absolute;left:50%;top:50%;width:12px;height:12px;border-radius:50%;transform:translate(-50%,-50%);background-color:var(--current-theme-color)}.task-text{flex-grow:1;margin-left:5px;color:var(--text-color);font-size:.95rem;width:100%;cursor:text;white-space:pre-wrap;word-break:break-word}.task-note{font-size:.85rem;color:var(--secondary-text);margin-top:3px}.task-item.completed .task-text{color:var(--secondary-text)}.task-text.editing{outline:none;border-bottom:1px dashed var(--current-theme-color);padding-bottom:2px;min-height:1.2em}.header-actions{display:flex;align-items:center;margin-left:auto}.action-button,.mobile-action-btn{background:none;border:none;cursor:pointer;color:var(--current-theme-color);border-radius:6px;margin:0;font-size:1.2rem;padding:6px 8px;display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px}.action-button i,.mobile-action-btn i{display:inline-flex;align-items:center;justify-content:center;height:24px;width:24px}.action-button:last-child,.mobile-action-btn:last-child{padding-right:0}.action-button:hover,.mobile-action-btn:hover{background-color:var(--current-theme-hover-bg)}.empty-state{text-align:center;padding:30px 0;color:var(--secondary-text)}.mobile-header{display:none;padding:15px 0;border-bottom:1px solid var(--border-color);background-color:var(--bg-color);position:fixed;top:0;left:0;right:0;z-index:100}.mobile-back,.mobile-actions{position:absolute;top:50%;transform:translateY(-50%);display:flex;align-items:center}.mobile-back{left:15px;font-size:1.1rem;color:var(--current-theme-color);padding:6px 10px;border-radius:6px;cursor:pointer}.mobile-back:hover{background-color:var(--current-theme-hover-bg)}.mobile-title{text-align:center;font-size:1.1rem;font-weight:600;color:var(--current-theme-color)}.mobile-actions{right:15px}.mobile-action-btn:last-child{padding-right:0}.custom-plus{position:relative;display:inline-block;width:16px;height:16px}.custom-plus::before,.custom-plus::after{content:'';position:absolute;background-color:currentColor;border-radius:1px}.custom-plus::before{width:16px;height:2px;top:7px;left:0}.custom-plus::after{height:16px;width:2px;left:7px;top:0}@media (max-width:768px){.sidebar{display:none;width:100%;height:100vh;position:fixed;top:0;left:0;right:0;bottom:0;z-index:300;overflow-y:auto;background-color:#fff;padding-top:0;display:flex;flex-direction:column}.sidebar-list{flex-direction:column;padding:0;padding-top:20px;margin:0;background-color:#fff;flex-grow:1;overflow-y:auto;border-radius:0}.sidebar-item{padding:15px;margin:4px 10px;border-radius:0;font-size:1rem;text-align:left;height:40px;position:relative}.sidebar-item.active{background-color:transparent;color:var(--text-color);font-weight:400}.sidebar-item::after{content:'›';position:absolute;right:15px;font-size:1.5rem;color:#c7c7cc}.sidebar-item:hover{background-color:var(--sidebar-hover);border-radius:8px}.sidebar-more{display:flex;opacity:1;right:45px}.sidebar-more:hover{background-color:rgba(0,0,0,.08)}.sidebar-icon{margin-right:15px;margin-bottom:0}.sidebar-add{border-top:1px solid #f0f0f0;margin-top:auto;position:sticky;bottom:0;z-index:10;width:100%;background-color:#fff}.mobile-header{padding:15px 0}.list-header{display:none}.main-content{margin-left:0;padding:60px 0 0;height:calc(100vh - 60px);overflow-y:auto;background-color:#fff;width:100%}.task-list{background-color:#fff;border-radius:0;box-shadow:none;margin:0;padding:0;width:100%;overflow-x:hidden;overflow-y:auto}.task-item{padding:15px 0}.task-content{padding:0 15px}.task-item::after{background-color:var(--mobile-divider-color);width:100vw;left:0}.task-checkbox{width:22px;height:22px}.task-text{font-size:1rem;padding-right:35px}.mobile-title{flex:1;text-align:center;font-weight:600;font-size:1.1rem}.mobile-back{padding:8px;left:0}.mobile-back i{margin-right:6px;font-size:1rem;line-height:1}.mobile-back span{font-size:1rem;line-height:1}.mobile-actions{right:0;display:flex}.empty-state{margin:0;padding:30px 20px;background-color:#fff;border-radius:0;box-shadow:none}.app-container{padding:0;border-radius:0;max-height:100%;height:100dvh}.app-header{padding:10px 15px;border-radius:0}.task-item .info-task-btn{right:2px!important;opacity:0!important}.task-item:hover .info-task-btn{opacity:1!important}.task-text{font-size:1rem;padding-right:35px}.sidebar-popup-menu{position:fixed;top:auto!important;left:auto!important;right:20px!important}}.task-item .info-task-btn{position:absolute!important;right:2px!important;top:50%!important;transform:translateY(-50%)!important;background:none;border:none;color:var(--secondary-text);cursor:pointer;padding:5px;border-radius:50%;font-size:1.1rem;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;opacity:0!important;transition:opacity .15s ease-in-out,background-color .15s ease-in-out}.task-item:hover .info-task-btn{opacity:1!important}.info-task-btn:hover{background-color:rgba(0,0,0,.08);color:var(--current-theme-color)}.task-item .delete-task-btn,.task-item .info-task-btn{opacity:1;right:15px}.task-item .info-task-btn{right:50px}.task-text{font-size:1rem;padding-right:75px}.task-popup-menu{position:fixed;background-color:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:8px 0;min-width:120px;z-index:1000;display:none;border:1px solid var(--border-color)}.task-popup-menu.show{display:block}.task-popup-menu-item{padding:8px 15px;cursor:pointer;font-size:14px;color:var(--text-color);display:flex;align-items:center;transition:background-color .2s}.task-popup-menu-item:hover{background-color:var(--sidebar-hover)}.task-popup-menu-item.delete{color:var(--theme-red)}.task-popup-menu-item i{margin-right:8px;font-size:14px}.toast-message{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,.7);color:#fff;padding:8px 16px;border-radius:4px;font-size:14px;z-index:2000;opacity:0;transition:opacity .3s}.toast-message.show{opacity:1}.sidebar-popup-menu{position:fixed;background-color:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:8px 0;min-width:120px;z-index:1000;display:none;border:1px solid var(--border-color)}.sidebar-popup-menu.show{display:block}.sidebar-popup-menu-item{padding:8px 15px;cursor:pointer;font-size:14px;color:var(--text-color);display:flex;align-items:center;transition:background-color .2s}.sidebar-popup-menu-item:hover{background-color:var(--sidebar-hover)}.sidebar-popup-menu-item.delete{color:var(--theme-red)}.sidebar-popup-menu-item i{margin-right:8px;font-size:14px}.sidebar-item span{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.sidebar-item span.editing{outline:none;border-bottom:1px dashed var(--current-theme-color);padding-bottom:2px;min-width:30px}
    </style>
</head>
<body data-theme="purple">
    <div class="app-container">
        <div class="mobile-header">
            <div class="mobile-back"><i class="bi bi-chevron-left"></i><span>列表</span></div>
            <div class="mobile-title">每日清单</div>
            <div class="mobile-actions">
                <button class="mobile-action-btn"><span class="custom-plus"></span></button>
                <button class="mobile-action-btn"><i class="bi bi-three-dots"></i></button>
            </div>
        </div>
        
        <div class="sidebar">
            <ul class="sidebar-list">
                <li class="sidebar-item active">
                    <div class="sidebar-icon purple">每</div>
                    <span>每日清单</span>
                    <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                    <div class="sidebar-popup-menu">
                        <div class="sidebar-popup-menu-item edit"><i class="bi bi-pencil"></i>编辑名称</div>
                        <div class="sidebar-popup-menu-item delete"><i class="bi bi-trash3"></i>删除列表</div>
                    </div>
                </li>
                <li class="sidebar-item">
                    <div class="sidebar-icon blue">心</div>
                    <span>心情</span>
                    <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                    <div class="sidebar-popup-menu">
                        <div class="sidebar-popup-menu-item edit"><i class="bi bi-pencil"></i>编辑名称</div>
                        <div class="sidebar-popup-menu-item delete"><i class="bi bi-trash3"></i>删除列表</div>
                    </div>
                </li>
                <li class="sidebar-item">
                    <div class="sidebar-icon red">生</div>
                    <span>生日备注</span>
                    <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                    <div class="sidebar-popup-menu">
                        <div class="sidebar-popup-menu-item edit"><i class="bi bi-pencil"></i>编辑名称</div>
                        <div class="sidebar-popup-menu-item delete"><i class="bi bi-trash3"></i>删除列表</div>
                    </div>
                </li>
            </ul>
            <div class="sidebar-add"><i class="bi bi-plus-circle"></i><span>添加列表</span></div>
        </div>
        
        <div class="main-content">
            <div class="content-inner">
                <div class="list-header">
                    <h1 class="list-title">每日清单</h1>
                    <div class="header-actions">
                        <button class="action-button"><span class="custom-plus"></span></button>
                        <button class="action-button"><i class="bi bi-three-dots"></i></button>
                    </div>
                </div>
                <ul class="task-list" id="task-list"><div class="empty-state">载入中...</div></ul>
            </div>
        </div>
    </div>

    <div id="custom-confirm" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.65);z-index:2000;justify-content:center;align-items:center;">
        <div style="background-color:white;border-radius:12px;width:460px;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,0.15);overflow:hidden;display:flex;flex-direction:column;">
            <div style="padding:40px 40px 30px 40px;text-align:center;display:flex;flex-direction:column;justify-content:center;min-height:140px;">
                <h3 id="confirm-title" style="margin:0 0 16px 0;font-size:22px;font-weight:600;letter-spacing:-0.2px;color:#333;"></h3>
                <p id="confirm-message" style="margin:0;color:#666;font-size:16px;line-height:1.5;"></p>
            </div>
            <div style="display:flex;padding:0 40px 40px 40px;gap:16px;justify-content:center;">
                <button id="confirm-cancel" style="width:180px;height:38px;background-color:#007bff;border:none;border-radius:8px;font-size:16px;cursor:pointer;color:white;font-weight:500;transition:all 0.2s ease;padding:0;box-shadow:0 2px 4px rgba(0,123,255,0.2);" onmouseover="this.style.backgroundColor='#0069d9';this.style.boxShadow='0 4px 8px rgba(0,123,255,0.3)';" onmouseout="this.style.backgroundColor='#007bff';this.style.boxShadow='0 2px 4px rgba(0,123,255,0.2)';">取消</button>
                <button id="confirm-ok" style="width:180px;height:38px;background-color:#f5f5f5;border:none;border-radius:8px;font-size:16px;cursor:pointer;color:#ff453a;font-weight:500;transition:all 0.2s ease;padding:0;box-shadow:0 2px 4px rgba(0,0,0,0.05);" onmouseover="this.style.backgroundColor='#e8e8e8';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.backgroundColor='#f5f5f5';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">删除</button>
            </div>
        </div>
    </div>
    
    <style>
        /* 没有动画效果 */
    </style>
    


    <script>
        const SUPABASE_URL = 'https://fmxddvjgkykuqwmasigo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZteGRkdmpna3lrdXF3bWFzaWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwNDMzMjcsImV4cCI6MjA1OTYxOTMyN30.XCU4-03oajGh6M2-PNiBotCZSIDn_nJXkIC0Thjjfqo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // === Supabase Realtime 实时推送订阅 ===
        // 订阅 todos 表的所有变动，实现多端实时同步
        supabase
          .channel('public:todos')
          .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'todos' },
            payload => {
              // 只要有变动，自动刷新任务列表
              // 可根据payload.eventType做更细粒度处理
              loadBirthdays();
            }
          )
          .subscribe();

        const taskList = document.getElementById('task-list');
        const sidebarList = document.querySelector('.sidebar-list');

        // 记录最近添加的任务，用于防止重复
        window.lastAddedTask = {
            text: null,
            timestamp: 0
        };
        
        async function loadBirthdays() {
            try {
                // 设置加载标志，防止递归调用
                if (window.isLoadingData) return;
                window.isLoadingData = true;
                
                // 保存当前正在编辑的临时任务（如果有）
                const tempTask = window.currentEditingTempTask;
                let tempTaskText = '';
                let shouldPreserveTempTask = false;
                
                // 检查正在编辑的临时任务
                if (tempTask && tempTask.parentNode) {
                    const textElement = tempTask.querySelector('.task-text');
                    if (textElement) {
                        tempTaskText = textElement.textContent.trim();
                        shouldPreserveTempTask = (tempTaskText !== '');
                        
                        // 如果有文本内容，尝试保存
                        if (tempTaskText !== '') {
                            try {
                                // 如果编辑中的临时任务有内容，但不想保存并重新加载
                                // 不执行保存操作，只保留临时任务
                            } catch (error) {
                                console.error('保存临时任务失败:', error);
                            }
                        } else {
                            // 如果临时任务为空，移除它
                            shouldPreserveTempTask = false;
                            if (tempTask.parentNode) {
                                tempTask.parentNode.removeChild(tempTask);
                            }
                            window.currentEditingTempTask = null;
                        }
                    }
                }
                
                // 显示加载中状态，但保留任何正在编辑的任务
                if (!shouldPreserveTempTask && !document.querySelector('.task-item.temp-task')) {
                    taskList.innerHTML = `<div class="empty-state">载入中...</div>`;
                }
                
                const { data, error } = await supabase
                    .from('todos')
                    .select('id, task, is_completed, created_at')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                // 渲染数据，并保留临时任务（如果需要）
                renderBirthdays(data || [], shouldPreserveTempTask ? tempTask : null, tempTaskText);
            } catch (error) {
                console.error('加载数据失败:', error);
                // 仍然显示错误消息，除非有临时任务
                if (!window.currentEditingTempTask) {
                    taskList.innerHTML = `<div class="empty-state">加载失败，请重试</div>`;
                }
            } finally {
                // 重置加载标志
                setTimeout(() => {
                    window.isLoadingData = false;
                }, 300);
            }
        }

        function renderBirthdays(birthdays, tempTask, tempTaskText) {
            if (!birthdays || !Array.isArray(birthdays) || birthdays.length === 0) {
                const mockData = [
                    { id: 1, name: "分组", note: "", is_completed: false },
                    { id: 2, name: "代码管理改为GitHub界面", note: "", is_completed: true },
                    { id: 3, name: "写一个云词的灵感点子结构图布记录器", note: "", is_completed: false },
                    { id: 4, name: "查询J金价", note: "", is_completed: true },
                    { id: 5, name: "写个主页", note: "", is_completed: false },
                    { id: 6, name: "添加时间线", note: "", is_completed: false },
                    { id: 7, name: "谷歌2.5a代码能力做个工程测试", note: "", is_completed: true },
                    { id: 8, name: "HTML转WXML的解决方案实现", note: "", is_completed: false }
                ];
                
                renderTaskItems(mockData, 'name', tempTask, tempTaskText);
                return;
            }

            renderTaskItems(birthdays, 'task', tempTask, tempTaskText);
        }

        function renderTaskItems(items, textProperty, tempTask, tempTaskText) {
            // 保存当前正在编辑的临时任务
            let shouldPreserveTempTask = tempTask && tempTask.parentNode && tempTaskText && tempTaskText.trim() !== '';
            
            let html = '';
            items.forEach(item => {
                // 格式化创建时间
                let creationTime = '未知';
                if (item.created_at) {
                    try {
                        creationTime = new Date(item.created_at).toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                    } catch (e) {
                        console.error('格式化时间失败:', item.created_at, e);
                    }
                }

                html += `<li class="task-item ${item.is_completed ? 'completed' : ''}" data-id="${item.id}">
    <input type="checkbox" class="task-checkbox" ${item.is_completed ? 'checked' : ''}>
    <div class="task-content">
        <span class="task-text" contenteditable="false">${(item[textProperty] || '').replace(/\n/g, '<br>')}</span>
        ${item.note ? `<div class="task-note">${item.note}</div>` : ''}
        <button class="info-task-btn" data-created-at="${item.created_at || ''}"><i class="bi bi-three-dots-vertical"></i></button>
        <div class="task-popup-menu">
            <div class="task-popup-menu-item view-info">
                <i class="bi bi-info-circle"></i>创建: ${creationTime}
            </div>
            <div class="task-popup-menu-item copy">
                <i class="bi bi-clipboard"></i>复制
            </div>
            <div class="task-popup-menu-item delete">
                <i class="bi bi-trash3"></i>删除
            </div>
        </div>
    </div>
</li>`;
            });
            
            // 如果当前没有临时任务，直接渲染
            if (!shouldPreserveTempTask) {
                taskList.innerHTML = html;
            } else {
                // 保留临时任务，先移除它
                if (tempTask.parentNode) {
                    tempTask.parentNode.removeChild(tempTask);
                }
                
                // 渲染新的任务列表
                taskList.innerHTML = html;
                
                // 将临时任务重新添加到顶部
                if (taskList.firstChild) {
                    taskList.insertBefore(tempTask, taskList.firstChild);
                } else {
                    taskList.appendChild(tempTask);
                }
                
                // 重新聚焦到临时任务
                const textElement = tempTask.querySelector('.task-text');
                if (textElement) {
                    textElement.focus();
                    
                    // 将光标放到文本的末尾
                    const range = document.createRange();
                    const selection = window.getSelection();
                    range.selectNodeContents(textElement);
                    range.collapse(false); // 折叠到末尾
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            
            setupTaskListeners();
        }

        function setupTaskListeners() {
            taskList.removeEventListener('change', handleTaskChange);
            taskList.addEventListener('change', handleTaskChange);
            
            // 移除旧的事件监听器，防止重复绑定
            taskList.removeEventListener('click', handleTaskClick);
            taskList.addEventListener('click', handleTaskClick);
            
            // 监听键盘事件，处理编辑完成
            taskList.removeEventListener('keydown', handleTaskKeydown);
            taskList.addEventListener('keydown', handleTaskKeydown);
            
            // 监听失去焦点事件，保存编辑内容
            taskList.removeEventListener('focusout', handleTaskFocusOut);
            taskList.addEventListener('focusout', handleTaskFocusOut);
        }

        function handleTaskChange(event) {
            if (event.target.classList.contains('task-checkbox')) {
                const checkbox = event.target;
                const taskItem = checkbox.closest('.task-item');
                if (!taskItem) return;

                const id = taskItem.dataset.id;
                const isCompleted = checkbox.checked;

                taskItem.classList.toggle('completed', isCompleted);
                toggleTaskStatus(id, isCompleted);
            }
        }

        function handleTaskClick(event) {
            // 如果有正在编辑的临时任务，先处理它
            if (window.currentEditingTempTask) {
                const textElement = window.currentEditingTempTask.querySelector('.task-text');
                if (textElement && !window.currentEditingTempTask.contains(event.target)) {
                    // 检查是否已经在保存过程中
                    if (window.currentEditingTempTask.dataset.saving === "true") {
                        console.log("任务已经在保存中，避免重复保存");
                        return;
                    }
                    
                    const newText = textElement.textContent.trim();
                    if (newText !== '') {
                        // 标记为正在保存
                        window.currentEditingTempTask.dataset.saving = "true";
                        
                        // 将文本框设为不可编辑
                        textElement.contentEditable = "false";
                        textElement.classList.remove('editing');
                        
                        // 添加新任务
                        addTask(newText);
                    }
                    
                    // 移除临时任务
                    if (window.currentEditingTempTask.parentNode) {
                        window.currentEditingTempTask.parentNode.removeChild(window.currentEditingTempTask);
                    }
                    
                    window.currentEditingTempTask = null;
                }
            }
            
            // 如果点击的是信息按钮
            if (event.target.closest('.info-task-btn')) {
                const infoButton = event.target.closest('.info-task-btn');
                const taskItem = infoButton.closest('.task-item');
                
                if (taskItem) {
                    const menuElement = taskItem.querySelector('.task-popup-menu');
                    
                    // 关闭所有其他打开的菜单
                    document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                        if (menu !== menuElement) {
                            menu.classList.remove('show');
                        }
                    });
                    
                    // 切换当前菜单的显示状态
                    menuElement.classList.toggle('show');
                    
                    // 根据按钮位置调整菜单位置
                    positionPopupMenu(infoButton, menuElement);
                    
                    // 阻止事件冒泡，防止立即触发document点击事件关闭菜单
                    event.stopPropagation();
                }
                return; // 阻止进一步处理
            }
            
            // 处理菜单项点击
            if (event.target.closest('.task-popup-menu-item')) {
                const menuItem = event.target.closest('.task-popup-menu-item');
                const taskItem = menuItem.closest('.task-item');
                const taskId = taskItem.dataset.id;
                
                // 点击删除选项
                if (menuItem.classList.contains('delete')) {
                    // 使用自定义对话框删除任务
                    showCustomConfirm(
                        '删除任务？', 
                        '此任务将被永久删除', 
                        () => deleteTask(taskId)
                    );
                }
                
                // 点击复制选项
                if (menuItem.classList.contains('copy')) {
                    const taskText = taskItem.querySelector('.task-text').textContent;
                    copyToClipboard(taskText);
                    // 显示一个小提示，表明已复制
                    showToast('已复制到剪贴板');
                }
                
                // 关闭菜单
                const menuElement = taskItem.querySelector('.task-popup-menu');
                menuElement.classList.remove('show');
                
                event.stopPropagation();
                return;
            }
            
            // 如果点击的是文本元素
            if (event.target.classList.contains('task-text')) {
                const textElement = event.target;
                const taskItem = textElement.closest('.task-item');
                
                // 如果任务已完成，不允许编辑
                if (taskItem.classList.contains('completed')) return;
                
                // 启用编辑
                enableTaskEditing(textElement);
            }
        }

        // 弹出菜单位置调整函数
        function positionPopupMenu(button, menu) {
            // 获取按钮的位置信息
            const buttonRect = button.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            
            // 计算弹出菜单的位置
            const isRightAligned = window.innerWidth - buttonRect.right < menuRect.width;
            const isMobile = window.innerWidth <= 768;
            
            // 清除之前的样式
            menu.style.top = '';
            menu.style.right = '';
            menu.style.left = '';
            
            if (isMobile) {
                // 移动设备上，菜单显示在按钮下方并居中
                menu.style.top = `${buttonRect.bottom + 5}px`;
                menu.style.left = `${buttonRect.left + (buttonRect.width/2) - (menuRect.width/2)}px`;
            } else {
                // 桌面设备上，菜单显示在按钮右侧
                menu.style.top = `${buttonRect.top}px`;
                
                if (isRightAligned) {
                    // 如果右侧空间不足，显示在按钮左侧
                    menu.style.right = `${window.innerWidth - buttonRect.left + 5}px`;
                } else {
                    // 否则显示在按钮右侧
                    menu.style.left = `${buttonRect.right + 5}px`;
                }
            }
        }

        // 侧边栏弹出菜单位置调整函数
        function positionSidebarMenu(button, menu) {
            // 获取按钮的位置信息
            const buttonRect = button.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            
            // 清除之前的样式
            menu.style.top = '';
            menu.style.right = '';
            menu.style.left = '';
            
            // 菜单显示在按钮右侧
            menu.style.top = `${buttonRect.top}px`;
            
            // 检查右侧空间是否足够
            const isRightAligned = window.innerWidth - buttonRect.right < menuRect.width;
            
            if (isRightAligned) {
                // 如果右侧空间不足，显示在按钮左侧
                menu.style.right = `${window.innerWidth - buttonRect.left + 5}px`;
            } else {
                // 否则显示在按钮右侧
                menu.style.left = `${buttonRect.right + 5}px`;
            }

        }

        function handleTaskKeydown(event) {
            if (event.target.classList.contains('task-text') && event.target.contentEditable === 'true') {
                // 按下Ctrl+Enter组合键完成编辑
                if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                    event.preventDefault();
                    finishEditing(event.target);
                }
                // 按下Escape键取消编辑
                else if (event.key === 'Escape') {
                    event.preventDefault();
                    cancelEditing(event.target);
                }
                // 普通回车键，不拦截，让浏览器实现默认的换行行为
            }
        }

        function handleTaskFocusOut(event) {
            if (event.target.classList.contains('task-text') && event.target.contentEditable === 'true') {
                finishEditing(event.target);
            }
        }

        function finishEditing(textElement) {
            const taskItem = textElement.closest('.task-item');
            const taskId = taskItem.dataset.id;
            const newText = htmlToPlainText(textElement.innerHTML);
            
            // 确保内容不为空
            if (newText === '') {
                cancelEditing(textElement);
                return;
            }
            
            // 更新UI
            textElement.contentEditable = "false";
            textElement.classList.remove('editing');
            
            // 检查是否为临时任务
            if (taskItem.classList.contains('temp-task') || (typeof taskId === 'string' && taskId.startsWith('temp-'))) {
                // 如果是临时任务，直接添加为新任务
                addTask(newText);
                if (taskItem && taskItem.parentNode) {
                    taskItem.parentNode.removeChild(taskItem);
                }
            } else {
                // 更新现有任务
                updateTaskText(taskId, newText);
            }
        }

        function cancelEditing(textElement) {
            const taskItem = textElement.closest('.task-item');
            
            // 检查是否为临时任务
            if (taskItem.classList.contains('temp-task') || taskItem.dataset.tempFlag) {
                // 如果是临时任务，直接移除
                if (taskItem && taskItem.parentNode) {
                    taskItem.parentNode.removeChild(taskItem);
                }
                return;
            }
            
            const taskId = taskItem.dataset.id;
            
            // 通过重新加载数据来取消编辑
            loadBirthdays();
        }

        async function updateTaskText(id, newText) {
            try {
                // 检查ID类型，防止类型错误
                if (typeof id === 'string' && (id.startsWith('temp-') || id.startsWith('new-task-'))) {
                    console.warn('尝试更新临时任务，将作为新任务添加');
                    addTask(newText);
                    return;
                }
                
                // 确保文本中的换行被保留
                const { error } = await supabase
                    .from('todos')
                    .update({ task: newText })
                    .eq('id', id);
                
                if (error) throw error;
            } catch (error) {
                console.error('更新任务内容失败:', error);
                alert('更新失败: ' + error.message);
                loadBirthdays(); // 出错时重新加载
            }
        }

        async function addTask(taskText) {
            // 声明tempId变量在函数作用域的开头，使其在catch块中也可访问
            let tempId = 'temp-' + Date.now();
            try {
                // 检查任务文本是否为空
                if (!taskText || taskText.trim() === '') {
                    console.warn('任务内容不能为空');
                    return null;
                }
                
                // 防止短时间内重复添加相同任务
                const now = Date.now();
                const timeSinceLastAdd = now - window.lastAddedTask.timestamp;
                if (window.lastAddedTask.text === taskText && timeSinceLastAdd < 2000) {
                    console.warn('防止重复添加相同任务:', taskText);
                    return null;
                }
                
                // 更新最近添加的任务记录
                window.lastAddedTask = {
                    text: taskText,
                    timestamp: now
                };
                
                // 临时在UI中显示添加的任务
                // 使用innerText保留换行
                const tempElement = document.createElement('div');
                const span = document.createElement('span');
                span.className = 'task-text';
                span.textContent = taskText; // 使用textContent来正确设置内容并保留换行
                
                const tempTaskHTML = `<li class="task-item" data-id="${tempId}">
                    <input type="checkbox" class="task-checkbox">
                    <div class="task-content">
                    </div>
                </li>`;
                
                // 如果有"载入中..."或"空列表"状态，则清除
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) {
                    taskList.innerHTML = '';
                }
                
                // 添加到列表顶部
                const taskListElem = document.getElementById('task-list');
                tempElement.innerHTML = tempTaskHTML;
                const newTaskItem = tempElement.firstChild;
                const taskContent = newTaskItem.querySelector('.task-content');
                taskContent.appendChild(span);
                
                if (taskListElem.firstChild) {
                    taskListElem.insertBefore(newTaskItem, taskListElem.firstChild);
                } else {
                    taskListElem.appendChild(newTaskItem);
                }
                
                // 发送到服务器，保留换行符
                const { data, error } = await supabase
                    .from('todos')
                    .insert([{ task: taskText, is_completed: false }])
                    .select();
                
                if (error) throw error;
                
                // 用真实ID替换临时ID
                if (data && data.length > 0) {
                    const newTask = data[0];
                    const tempTask = document.querySelector(`[data-id="${tempId}"]`);
                    if (tempTask) {
                        tempTask.dataset.id = newTask.id;
                    } else {
                        // 如果找不到临时任务元素，重新加载整个列表
                        loadBirthdays();
                    }
                } else {
                    // 如果没有返回数据，重新加载整个列表
                    loadBirthdays();
                }
                
                return data;
            } catch (error) {
                console.error('添加任务失败:', error);
                // 移除临时添加的任务元素
                const tempTask = document.querySelector(`[data-id="${tempId}"]`);
                if (tempTask) {
                    tempTask.parentNode.removeChild(tempTask);
                }
                // 显示错误消息
                alert('添加失败: ' + error.message);
                return null;
            }
        }

        // 修复创建空白可编辑任务的功能
        function createEmptyEditableTask() {
            console.log("创建新任务函数被调用");
            
            try {
                // 确保任务列表元素存在
                const taskList = document.getElementById('task-list');
                if (!taskList) {
                    console.error("找不到任务列表元素!");
                    return;
                }
                
                // 如果已经存在正在编辑的临时任务，先聚焦到它
                if (window.currentEditingTempTask) {
                    console.log("已存在临时任务，聚焦到它");
                    const existingTextElement = window.currentEditingTempTask.querySelector('.task-text');
                    if (existingTextElement) {
                        existingTextElement.focus();
                        return; // 如果已经存在则直接返回，不创建新的
                    }
                }

                // 使用一个标志来标识这是一个临时任务
                const tempFlag = 'new-task-' + Date.now();
                console.log("创建临时任务，ID:", tempFlag);
                
                // 创建新的任务项HTML元素
                const newTaskItem = document.createElement('li');
                newTaskItem.className = 'task-item temp-task';
                // 不使用数字ID，而是使用一个特殊标识
                newTaskItem.dataset.id = tempFlag;
                newTaskItem.dataset.tempFlag = 'true';
                newTaskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox">
                    <div class="task-content">
                        <span class="task-text editing" contenteditable="true"></span>
                    </div>
                    <button class="info-task-btn"><i class="bi bi-three-dots-vertical"></i></button>
                    <div class="task-popup-menu">
                        <div class="task-popup-menu-item view-info">
                            <i class="bi bi-info-circle"></i>创建于现在
                        </div>
                        <div class="task-popup-menu-item copy">
                            <i class="bi bi-clipboard"></i>复制
                        </div>
                        <div class="task-popup-menu-item delete">
                            <i class="bi bi-trash3"></i>删除
                        </div>
                    </div>
                `;
                
                console.log("任务列表元素:", taskList);
                
                // 清除可能存在的"载入中..."信息
                const emptyState = taskList.querySelector('.empty-state');
                if (emptyState) {
                    console.log("清除载入中状态");
                    taskList.innerHTML = '';
                }
                
                // 插入新任务到列表顶部
                console.log("插入新任务元素到列表");
                if (taskList.firstChild) {
                    taskList.insertBefore(newTaskItem, taskList.firstChild);
                } else {
                    taskList.appendChild(newTaskItem);
                }
                
                // 设置焦点并添加事件监听
                const textElement = newTaskItem.querySelector('.task-text');
                console.log("设置焦点到文本元素:", textElement);
                
                // 添加编辑提示
                textElement.setAttribute('data-tooltip', '按Ctrl+Enter完成编辑');
                textElement.title = '按回车换行，按Ctrl+Enter完成编辑';
                
                // 标记全局状态，表示当前有临时任务正在编辑
                window.currentEditingTempTask = newTaskItem;
                
                // 延迟一点设置焦点，确保DOM渲染完成
                setTimeout(() => {
                    if (textElement) {
                        textElement.focus();
                        // 创建一个新的选中范围
                        try {
                            const range = document.createRange();
                            const selection = window.getSelection();
                            range.selectNodeContents(textElement);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        } catch (err) {
                            console.error("设置光标位置失败:", err);
                        }
                    }
                }, 50);
                
                // 为新任务添加特殊的完成编辑处理
                textElement.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                        event.preventDefault();
                        console.log("按下Ctrl+Enter，保存任务");
                        finishTempTask(this);
                    } else if (event.key === 'Escape') {
                        event.preventDefault();
                        console.log("按下Escape，取消编辑");
                        removeTempTask(newTaskItem);
                        window.currentEditingTempTask = null;
                    }
                });
                
                // 失去焦点时保存，使用一个延时来避免和点击事件冲突
                textElement.addEventListener('focusout', function(event) {
                    // 使用setTimeout以确保这是在所有点击事件之后处理的
                    setTimeout(() => {
                        // 检查此元素是否仍在DOM中，可能在点击事件中已被移除
                        if (document.contains(this) && window.currentEditingTempTask === newTaskItem) {
                            console.log("失去焦点，保存任务");
                            finishTempTask(this);
                        }
                    }, 200);
                });
                
                // 处理临时任务的保存
                async function finishTempTask(textElement) {
                    console.log("执行finishTempTask");
                    if (!document.contains(textElement)) {
                        console.log("元素已不在DOM中，取消保存");
                        return;
                    }
                    
                    // 检查是否已经在保存过程中
                    if (newTaskItem.dataset.saving === "true") {
                        console.log("任务已经在保存中，避免重复保存");
                        return;
                    }
                    
                    const newText = htmlToPlainText(textElement.innerHTML);
                    console.log("任务文本:", newText);
                    if (newText !== '') {
                        try {
                            // 标记为正在保存
                            newTaskItem.dataset.saving = "true";
                            
                            // 显示保存中的状态
                            textElement.contentEditable = "false";
                            textElement.classList.remove('editing');
                            
                            // 调用添加任务API
                            console.log("调用addTask添加任务");
                            await addTask(newText);
                            
                            // 移除临时元素，数据会在addTask成功后重新加载
                            console.log("移除临时元素");
                            removeTempTask(newTaskItem);
                        } catch (err) {
                            console.error("添加任务时出错:", err);
                            // 取消保存状态
                            newTaskItem.dataset.saving = "false";
                            // 恢复可编辑状态，让用户重试
                            textElement.contentEditable = "true";
                            textElement.classList.add('editing');
                            textElement.focus();
                            return;
                        }
                    } else {
                        // 如果为空则移除此元素
                        console.log("任务为空，移除临时元素");
                        removeTempTask(newTaskItem);
                    }
                    
                    window.currentEditingTempTask = null;
                }
                
                // 移除临时任务元素
                function removeTempTask(taskItem) {
                    console.log("执行removeTempTask");
                    if (taskItem && taskItem.parentNode) {
                        taskItem.parentNode.removeChild(taskItem);
                    }
                    
                    if (window.currentEditingTempTask === taskItem) {
                        window.currentEditingTempTask = null;
                    }
                }
            } catch (err) {
                console.error("创建任务失败:", err);
                alert("创建新任务失败，请刷新页面重试");
            }
        }

        // 在文档加载时初始化全局点击事件处理器
        function setupGlobalHandlers() {
            // 如果还没有添加过全局处理器，则添加
            if (!window.hasAddedGlobalTempTaskHandler) {
                console.log("添加全局临时任务处理器");
                window.hasAddedGlobalTempTaskHandler = true;
                
                document.addEventListener('click', function(event) {
                    if (!window.currentEditingTempTask) return;
                    
                    // 如果点击的不是临时任务或其子元素
                    if (!window.currentEditingTempTask.contains(event.target)) {
                        const textElement = window.currentEditingTempTask.querySelector('.task-text');
                        if (textElement) {
                            // 检查是否已经在保存过程中
                            if (window.currentEditingTempTask.dataset.saving === "true") {
                                console.log("任务已经在保存中，避免重复保存");
                                return;
                            }
                            
                            // 手动触发保存
                            const newText = htmlToPlainText(textElement.innerHTML);
                            if (newText !== '') {
                                // 标记为正在保存
                                window.currentEditingTempTask.dataset.saving = "true";
                                
                                // 将contentEditable设为false，防止在保存过程中继续编辑
                                textElement.contentEditable = "false";
                                textElement.classList.remove('editing');
                                
                                // 异步添加任务
                                addTask(htmlToPlainText(textElement.innerHTML)).then(() => {
                                    // 添加成功后移除临时任务
                                    if (window.currentEditingTempTask && window.currentEditingTempTask.parentNode) {
                                        window.currentEditingTempTask.parentNode.removeChild(window.currentEditingTempTask);
                                        window.currentEditingTempTask = null;
                                    }
                                }).catch(err => {
                                    console.error('点击其他区域保存任务失败:', err);
                                    // 取消保存状态
                                    if (window.currentEditingTempTask) {
                                        window.currentEditingTempTask.dataset.saving = "false";
                                        
                                        // 如果失败，回到编辑状态
                                        const textEl = window.currentEditingTempTask.querySelector('.task-text');
                                        if (textEl) {
                                            textEl.contentEditable = "true";
                                            textEl.classList.add('editing');
                                        }
                                    }
                                });
                            } else {
                                // 如果内容为空，直接移除临时任务
                                if (window.currentEditingTempTask && window.currentEditingTempTask.parentNode) {
                                    window.currentEditingTempTask.parentNode.removeChild(window.currentEditingTempTask);
                                }
                                
                                window.currentEditingTempTask = null;
                            }
                        }
                    }
                });
            }
        }

        async function toggleTaskStatus(id, isCompleted) {
            try {
                // 确保id是有效的
                if (!id || (typeof id === 'string' && (id.startsWith('temp-') || id.startsWith('new-task-')))) {
                    console.warn('尝试更新临时任务状态，已忽略');
                    return;
                }
                
                // 立即更新UI状态，不等待服务器响应
                const taskItem = document.querySelector(`.task-item[data-id="${id}"]`);
                if (taskItem) {
                    taskItem.classList.toggle('completed', isCompleted);
                }
                
                // 发送请求到服务器
                const { error } = await supabase
                    .from('todos')
                    .update({ is_completed: isCompleted })
                    .eq('id', id);
                
                if (error) {
                    throw error;
                }
            } catch (error) {
                console.error('更新任务状态失败:', error);
                
                // 如果出错，恢复UI状态
                const taskItem = document.querySelector(`.task-item[data-id="${id}"]`);
                if (taskItem) {
                    taskItem.classList.toggle('completed', !isCompleted);
                    const checkbox = taskItem.querySelector('.task-checkbox');
                    if (checkbox) {
                        checkbox.checked = !isCompleted;
                    }
                }
                
                // 显示错误消息
                alert(`更新失败: ${error.message || '服务器错误'}`);
            }
        }

        async function deleteTask(id) {
            try {
                const { error } = await supabase
                    .from('todos')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                loadBirthdays();
            } catch (error) {
                console.error('删除任务失败:', error);
                alert('删除失败: ' + error.message);
            }
        }

        // 添加清除所有已完成任务的功能
        async function clearCompletedTasks() {
            try {
                // 获取所有已完成的任务ID
                const completedItems = document.querySelectorAll('.task-item.completed');
                if (completedItems.length === 0) {
                    alert('没有已完成的任务需要清除');
                    return;
                }
                
                // 显示加载状态
                document.body.style.cursor = 'wait';
                
                // 从数据库中删除所有已完成的任务
                const { error } = await supabase
                    .from('todos')
                    .delete()
                    .eq('is_completed', true);
                
                if (error) throw error;
                
                // 重新加载任务列表
                loadBirthdays();
                
                // 恢复正常光标
                document.body.style.cursor = 'default';
            } catch (error) {
                console.error('清除已完成任务失败:', error);
                alert('清除失败: ' + error.message);
                document.body.style.cursor = 'default';
            }
        }

        function getThemeFromIcon(iconElement) {
            if (!iconElement) return 'purple';
            return iconElement.classList.contains('blue') ? 'blue' :
                   iconElement.classList.contains('red') ? 'red' : 'purple';
        }

        function updateThemeAndTitle(listItem) {
            const listTitleText = listItem.querySelector('span').textContent;
            const iconElement = listItem.querySelector('.sidebar-icon');
            const themeColor = getThemeFromIcon(iconElement);

            document.querySelector('.list-title').textContent = listTitleText;
            document.querySelector('.mobile-title').textContent = listTitleText;
            document.body.dataset.theme = themeColor;

            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            listItem.classList.add('active');

            loadBirthdays();

            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').style.display = 'none';
                document.querySelector('.main-content').style.display = 'block';
                document.querySelector('.mobile-header').style.display = 'flex';
                document.querySelector('.mobile-back').style.visibility = 'visible';
                document.querySelector('.mobile-actions').style.display = 'flex';
            }
        }

        function initialize() {
            console.log("初始化应用...");
            setupTaskListeners();
            setupGlobalHandlers();
            
            // 启用 Popover (重复调用以确保新元素也能用)
            const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            const popoverList = [...popoverTriggerList].map(popoverTriggerEl => {
                // 避免重复初始化，如果已有实例则跳过
                if (!bootstrap.Popover.getInstance(popoverTriggerEl)) {
                    return new bootstrap.Popover(popoverTriggerEl);
                }
                return null;
            }).filter(Boolean);
            
            const initialActiveItem = document.querySelector('.sidebar-item.active') || document.querySelector('.sidebar-item');
            if (initialActiveItem) {
                updateThemeAndTitle(initialActiveItem);
            } else {
                loadBirthdays();
            }

            // 全局点击事件处理
            document.addEventListener('click', function(e) {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && sidebar.style.display === 'flex' &&
                    !sidebar.contains(e.target) &&
                    !e.target.closest('.mobile-back') &&
                    window.innerWidth <= 768) {
                    sidebar.style.display = 'none';
                    document.querySelector('.main-content').style.display = 'block';
                    document.querySelector('.mobile-header').style.display = 'flex';
                }
            });

            // 移动端返回按钮
            document.querySelector('.mobile-back').addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    sidebar.style.display = 'flex';
                    document.querySelector('.main-content').style.display = 'none';
                    document.querySelector('.mobile-header').style.display = 'none';
                }
            });

            // 窗口大小调整
            window.addEventListener('resize', function() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const mobileHeader = document.querySelector('.mobile-header');

                if (window.innerWidth > 768) {
                    sidebar.style.display = '';
                    mainContent.style.display = '';
                    mobileHeader.style.display = 'none';
                } else if (sidebar.style.display !== 'flex') {
                    sidebar.style.display = 'none';
                    mainContent.style.display = 'block';
                    mobileHeader.style.display = 'flex';
                } else {
                    mainContent.style.display = 'none';
                    mobileHeader.style.display = 'none';
                }
            });

            // 移动端更多操作按钮
            document.querySelector('.mobile-actions .bi-three-dots').closest('button').addEventListener('click', function() {
                const listTitle = document.querySelector('.mobile-title').textContent;
                if (listTitle === '列表') return;

                const action = prompt(`${listTitle}选项：\n1. 清除已完成任务\n2. 全部标记完成\n3. 全部标记未完成\n请输入数字或取消`);

                if (action === '1') {
                    showCustomConfirm(
                        '清除已完成的任务？', 
                        '所有已完成的任务将被永久删除', 
                        clearCompletedTasks
                    );
                } else if (action === '2' || action === '3') {
                    const markAsCompleted = action === '2';
                    const selector = markAsCompleted ? '.task-checkbox:not(:checked)' : '.task-checkbox:checked';
                    document.querySelectorAll(selector).forEach(checkbox => {
                        checkbox.checked = markAsCompleted;
                        const taskItem = checkbox.closest('.task-item');
                        if (taskItem) {
                            taskItem.classList.toggle('completed', markAsCompleted);
                            toggleTaskStatus(taskItem.dataset.id, markAsCompleted);
                        }
                    });
                }
            });

            // PC端更多操作按钮
            document.querySelector('.header-actions .bi-three-dots').closest('button').addEventListener('click', function() {
                const listTitle = document.querySelector('.list-title').textContent;
                
                const action = prompt(`${listTitle}选项：\n1. 清除已完成任务\n2. 全部标记完成\n3. 全部标记未完成\n请输入数字或取消`);
                
                if (action === '1') {
                    showCustomConfirm(
                        '清除已完成的任务？', 
                        '所有已完成的任务将被永久删除', 
                        clearCompletedTasks
                    );
                } else if (action === '2' || action === '3') {
                    const markAsCompleted = action === '2';
                    const selector = markAsCompleted ? '.task-checkbox:not(:checked)' : '.task-checkbox:checked';
                    document.querySelectorAll(selector).forEach(checkbox => {
                        checkbox.checked = markAsCompleted;
                        const taskItem = checkbox.closest('.task-item');
                        if (taskItem) {
                            taskItem.classList.toggle('completed', markAsCompleted);
                            toggleTaskStatus(taskItem.dataset.id, markAsCompleted);
                        }
                    });
                }
            });

            // 侧边栏点击处理
            sidebarList.addEventListener('click', function(e) {
                const targetItem = e.target.closest('.sidebar-item');
                const targetMore = e.target.closest('.sidebar-more');

                if (targetMore) {
                    e.stopPropagation();
                    const listItem = targetMore.closest('.sidebar-item');
                    const menuElement = listItem.querySelector('.sidebar-popup-menu');
                    
                    // 关闭所有其他打开的菜单
                    document.querySelectorAll('.sidebar-popup-menu.show').forEach(menu => {
                        if (menu !== menuElement) {
                            menu.classList.remove('show');
                        }
                    });
                    
                    // 切换当前菜单的显示状态
                    menuElement.classList.toggle('show');
                    
                    // 根据按钮位置调整菜单位置
                    positionSidebarMenu(targetMore, menuElement);
                    
                    e.stopPropagation();
                } else if (e.target.closest('.sidebar-popup-menu-item')) {
                    // 处理菜单项点击
                    const menuItem = e.target.closest('.sidebar-popup-menu-item');
                    const listItem = menuItem.closest('.sidebar-item');
                    const listName = listItem.querySelector('span').textContent;
                    
                    // 编辑名称
                    if (menuItem.classList.contains('edit')) {
                        // 获取列表项和名称元素
                        const listSpan = listItem.querySelector('span');
                        
                        // 使名称可编辑
                        makeListNameEditable(listSpan, listName, listItem);
                    } 
                    // 删除列表
                    else if (menuItem.classList.contains('delete')) {
                        deleteList(listItem);
                    }
                    
                    // 关闭菜单
                    const menuElement = listItem.querySelector('.sidebar-popup-menu');
                    menuElement.classList.remove('show');
                    
                    e.stopPropagation();
                } else if (targetItem) {
                    updateThemeAndTitle(targetItem);
                }
            });
            
            // 添加双击列表名称编辑功能
            sidebarList.addEventListener('dblclick', function(e) {
                // 检查是否点击了列表名称
                if (e.target.tagName === 'SPAN' && e.target.parentNode.classList.contains('sidebar-item')) {
                    e.stopPropagation();
                    const listSpan = e.target;
                    const listItem = listSpan.closest('.sidebar-item');
                    const listName = listSpan.textContent;
                    
                    // 使名称可编辑
                    makeListNameEditable(listSpan, listName, listItem);
                }
            });
            
            // 将列表名称变为可编辑状态的函数
            function makeListNameEditable(listSpan, listName, listItem) {
                // 使名称可编辑
                listSpan.contentEditable = "true";
                listSpan.classList.add('editing');
                
                // 设置焦点到名称
                listSpan.focus();
                
                // 选中所有文本
                const range = document.createRange();
                range.selectNodeContents(listSpan);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // 为名称添加编辑相关事件
                // 按Enter或失去焦点时保存
                function saveListName() {
                    const newName = listSpan.textContent.trim();
                    
                    // 确保名称不为空
                    if (newName === '') {
                        listSpan.textContent = listName; // 恢复原名称
                    } else if (newName !== listName) {
                        // 更新名称
                        listSpan.textContent = newName;
                        
                        // 更新图标文字为新名称的第一个字符
                        const iconElement = listItem.querySelector('.sidebar-icon');
                        if (iconElement) {
                            iconElement.textContent = newName.charAt(0);
                        }
                        
                        // 如果是当前活动列表，更新标题
                        if (listItem.classList.contains('active')) {
                            document.querySelector('.list-title').textContent = newName;
                            document.querySelector('.mobile-title').textContent = newName;
                        }
                    }
                    
                    // 移除编辑状态
                    listSpan.contentEditable = "false";
                    listSpan.classList.remove('editing');
                    
                    // 移除事件监听器
                    listSpan.removeEventListener('keydown', handleKeyDown);
                    listSpan.removeEventListener('blur', saveListName);
                }
                
                // 处理键盘事件
                function handleKeyDown(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // 阻止插入换行
                        saveListName();
                        listSpan.blur(); // 移除焦点
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        listSpan.textContent = listName; // 恢复原名称
                        listSpan.contentEditable = "false";
                        listSpan.classList.remove('editing');
                        listSpan.blur();
                        
                        // 移除事件监听器
                        listSpan.removeEventListener('keydown', handleKeyDown);
                        listSpan.removeEventListener('blur', saveListName);
                    }
                }
                
                // 添加事件监听器
                listSpan.addEventListener('keydown', handleKeyDown);
                listSpan.addEventListener('blur', saveListName);
            }

            // 移除了全屏按钮相关代码
            
            /*
            // 进入全屏的标准JavaScript代码，仅供参考：
            function enterFullscreen(element) {
                if(element.requestFullscreen) {
                    element.requestFullscreen();
                } else if(element.msRequestFullscreen) {      // IE
                    element.msRequestFullscreen();
                } else if(element.webkitRequestFullscreen) {  // Safari
                    element.webkitRequestFullscreen();
                } else if(element.mozRequestFullscreen) {     // Firefox
                    element.mozRequestFullscreen();
                }
            }
            
            // 使用方法：enterFullscreen(document.documentElement); // 全屏整个页面
            */

            // 添加列表按钮点击事件
            document.querySelector('.sidebar-add').addEventListener('click', function() {
                // 创建新的列表项
                const newItem = document.createElement('li');
                newItem.className = 'sidebar-item';
                newItem.innerHTML = `
                    <div class="sidebar-icon purple">新</div>
                    <span class="editing" contenteditable="true">新列表</span>
                    <div class="sidebar-more"><i class="bi bi-three-dots"></i></div>
                    <div class="sidebar-popup-menu">
                        <div class="sidebar-popup-menu-item edit">
                            <i class="bi bi-pencil"></i>编辑名称
                        </div>
                        <div class="sidebar-popup-menu-item delete">
                            <i class="bi bi-trash3"></i>删除列表
                        </div>
                    </div>
                `;
                
                // 添加到列表中
                const sidebarList = document.querySelector('.sidebar-list');
                sidebarList.appendChild(newItem);
                
                // 获取名称元素并设置焦点
                const listSpan = newItem.querySelector('span');
                
                // 设置焦点并选择所有文本
                setTimeout(() => {
                    listSpan.focus();
                    
                    // 选中所有文本
                    const range = document.createRange();
                    range.selectNodeContents(listSpan);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    // 为名称添加编辑相关事件
                    // 按Enter或失去焦点时保存
                    function saveNewListName() {
                        const listName = listSpan.textContent.trim();
                        
                        // 确保名称不为空
                        if (listName === '') {
                            // 如果为空，移除该列表项
                            if (newItem.parentNode) {
                                newItem.parentNode.removeChild(newItem);
                            }
                            return;
                        }
                        
                        // 更新图标中的首字符
                        const firstChar = listName.charAt(0);
                        newItem.querySelector('.sidebar-icon').textContent = firstChar;
                        
                        // 移除编辑状态
                        listSpan.contentEditable = "false";
                        listSpan.classList.remove('editing');
                        
                        // 切换到新创建的列表
                        updateThemeAndTitle(newItem);
                        
                        // 移除事件监听器
                        listSpan.removeEventListener('keydown', handleKeyDown);
                        listSpan.removeEventListener('blur', saveNewListName);
                    }
                    
                    // 处理键盘事件
                    function handleKeyDown(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // 阻止插入换行
                            saveNewListName();
                            listSpan.blur(); // 移除焦点
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            // 如果按ESC，取消创建
                            if (newItem.parentNode) {
                                newItem.parentNode.removeChild(newItem);
                            }
                        }
                    }
                    
                    // 添加事件监听器
                    listSpan.addEventListener('keydown', handleKeyDown);
                    listSpan.addEventListener('blur', saveNewListName);
                }, 50);
            });

            // 点击文档其他地方关闭所有弹出菜单
            document.addEventListener('click', function(event) {
                // 关闭任务弹出菜单
                if (!event.target.closest('.info-task-btn') && !event.target.closest('.task-popup-menu')) {
                    document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
                
                // 关闭侧边栏弹出菜单
                if (!event.target.closest('.sidebar-more') && !event.target.closest('.sidebar-popup-menu')) {
                    document.querySelectorAll('.sidebar-popup-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
            
            // 添加窗口大小调整监听器，在调整大小时重新定位所有显示的菜单
            window.addEventListener('resize', function() {
                // 重新定位任务弹出菜单
                document.querySelectorAll('.task-popup-menu.show').forEach(menu => {
                    const taskItem = menu.closest('.task-item');
                    if (taskItem) {
                        const infoButton = taskItem.querySelector('.info-task-btn');
                        if (infoButton) {
                            positionPopupMenu(infoButton, menu);
                        }
                    }
                });
                
                // 重新定位侧边栏弹出菜单
                document.querySelectorAll('.sidebar-popup-menu.show').forEach(menu => {
                    const sidebarItem = menu.closest('.sidebar-item');
                    if (sidebarItem) {
                        const moreButton = sidebarItem.querySelector('.sidebar-more');
                        if (moreButton) {
                            positionSidebarMenu(moreButton, menu);
                        }
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadBirthdays(); // 首次全量加载
            setupRealtime(); // 启用实时推送
        });

        function setupRealtime() {
            supabase
              .channel('public:todos')
              .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'todos' },
                payload => {
                  handleRealtimeChange(payload);
                }
              )
              .subscribe();
        }

        function handleRealtimeChange(payload) {
            const { eventType, new: newRow, old: oldRow } = payload;
            if (eventType === 'INSERT') {
                if (!insertTaskToDOM(newRow)) {
                    loadBirthdays(); // fallback
                }
            } else if (eventType === 'UPDATE') {
                if (!updateTaskInDOM(newRow)) {
                    loadBirthdays(); // fallback
                }
            } else if (eventType === 'DELETE') {
                if (!removeTaskFromDOM(oldRow.id)) {
                    loadBirthdays(); // fallback
                }
            }
        }

        // 插入新任务到DOM，已存在则不插入，返回true/false
        function insertTaskToDOM(task) {
            if (document.querySelector(`.task-item[data-id="${task.id}"]`)) return true;
            const taskListElem = document.getElementById('task-list');
            if (!taskListElem) return false;
            const temp = document.createElement('div');
            temp.innerHTML = renderTaskItemHTML(task);
            const newTaskItem = temp.firstChild;
            if (taskListElem.firstChild) {
                taskListElem.insertBefore(newTaskItem, taskListElem.firstChild);
            } else {
                taskListElem.appendChild(newTaskItem);
            }
            setupTaskListeners();
            return true;
        }

        // 更新任务内容到DOM，找不到则返回false
        function updateTaskInDOM(task) {
            const li = document.querySelector(`.task-item[data-id="${task.id}"]`);
            if (!li) return false;
            const newHTML = renderTaskItemHTML(task);
            const temp = document.createElement('div');
            temp.innerHTML = newHTML;
            const newLi = temp.firstChild;
            li.innerHTML = newLi.innerHTML;
            setupTaskListeners();
            return true;
        }

        // 从DOM中移除任务，找不到则返回false
        function removeTaskFromDOM(id) {
            const li = document.querySelector(`.task-item[data-id="${id}"]`);
            if (!li) return false;
            if (li.parentNode) li.parentNode.removeChild(li);
            return true;
        }

        // 渲染单个任务的HTML
        function renderTaskItemHTML(item) {
            let creationTime = '未知';
            if (item.created_at) {
                try {
                    creationTime = new Date(item.created_at).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                } catch (e) {}
            }
            return `<li class="task-item${item.is_completed ? ' completed' : ''}" data-id="${item.id}">
<input type="checkbox" class="task-checkbox" ${item.is_completed ? 'checked' : ''}>
<div class="task-content">
    <span class="task-text" contenteditable="false">${(item.task || '').replace(/\n/g, '<br>')}</span>
    ${item.note ? `<div class="task-note">${item.note}</div>` : ''}
    <button class="info-task-btn" data-created-at="${item.created_at || ''}"><i class="bi bi-three-dots-vertical"></i></button>
    <div class="task-popup-menu">
        <div class="task-popup-menu-item view-info">
            <i class="bi bi-info-circle"></i>创建: ${creationTime}
        </div>
        <div class="task-popup-menu-item copy">
            <i class="bi bi-clipboard"></i>复制
        </div>
        <div class="task-popup-menu-item delete">
            <i class="bi bi-trash3"></i>删除
        </div>
    </div>
</div>
</li>`;
        }
        
        // 自定义确认对话框函数
        function showCustomConfirm(title, message, okCallback) {
            const confirmDialog = document.getElementById('custom-confirm');
            const titleElement = document.getElementById('confirm-title');
            const messageElement = document.getElementById('confirm-message');
            const cancelButton = document.getElementById('confirm-cancel');
            const okButton = document.getElementById('confirm-ok');
            
            // 设置对话框内容
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // 立即显示对话框，没有动画
            confirmDialog.style.display = 'flex';
            
            // 绑定取消按钮事件
            const cancelHandler = () => {
                // 立即隐藏对话框，没有动画
                confirmDialog.style.display = 'none';
                
                cancelButton.removeEventListener('click', cancelHandler);
                okButton.removeEventListener('click', okHandler);
            };
            
            // 绑定确认按钮事件
            const okHandler = () => {
                // 立即隐藏对话框，没有动画
                confirmDialog.style.display = 'none';
                okCallback();
                
                cancelButton.removeEventListener('click', cancelHandler);
                okButton.removeEventListener('click', okHandler);
            };
            
            // 设置事件监听
            cancelButton.addEventListener('click', cancelHandler);
            okButton.addEventListener('click', okHandler);
            
            // 添加点击背景关闭对话框的功能
            const backdropClickHandler = (event) => {
                // 只有点击背景时才关闭
                if (event.target === confirmDialog) {
                    cancelHandler();
                }
            };
            
            confirmDialog.addEventListener('click', backdropClickHandler);
            
            // 一次性事件移除
            cancelButton.addEventListener('click', () => {
                confirmDialog.removeEventListener('click', backdropClickHandler);
            }, { once: true });
            
            okButton.addEventListener('click', () => {
                confirmDialog.removeEventListener('click', backdropClickHandler);
            }, { once: true });
        }
        
        // 列表删除功能
        function deleteList(listItem) {
            // 如果尝试删除最后一个列表项，显示提示并阻止删除
            const totalLists = document.querySelectorAll('.sidebar-item').length;
            if (totalLists <= 1) {
                showToast('无法删除最后一个列表');
                return;
            }
            
            // 获取列表名称
            const listName = listItem.querySelector('span').textContent;
            
            // 显示自定义确认对话框
            showCustomConfirm(
                `删除列表"${listName}"？`, 
                '此操作将删除列表中的所有提醒事项。', 
                () => {
                    // 如果删除的是当前激活的列表，切换到另一个列表
                    if (listItem.classList.contains('active')) {
                        // 查找下一个或上一个列表项
                        const nextItem = listItem.nextElementSibling;
                        const prevItem = listItem.previousElementSibling;
                        
                        // 优先选择下一个列表，如果没有则选择上一个
                        const newActiveItem = nextItem && nextItem.classList.contains('sidebar-item') ? 
                                            nextItem : 
                                            (prevItem && prevItem.classList.contains('sidebar-item') ? prevItem : null);
                        
                        if (newActiveItem) {
                            // 在删除后切换到新的列表
                            setTimeout(() => updateThemeAndTitle(newActiveItem), 0);
                        }
                    }
                    
                    // 从DOM中移除列表项
                    if (listItem.parentNode) {
                        listItem.parentNode.removeChild(listItem);
                    }
                    
                    // 显示成功提示
                    showToast('列表已删除');
                }
            );
        }

        // 确保全局函数在window对象上可用
        window.toggleTaskStatus = toggleTaskStatus;
        window.deleteTask = deleteTask;
        window.addTask = addTask;
        window.clearCompletedTasks = clearCompletedTasks;
        window.createEmptyEditableTask = createEmptyEditableTask;
        window.deleteList = deleteList;
        window.showCustomConfirm = showCustomConfirm;
        
        // 添加复制到剪贴板的功能
        function copyToClipboard(text) {
            // 创建一个临时的textarea元素
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';  // 避免滚动到底部
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                // 尝试复制
                document.execCommand('copy');
                console.log('文本已复制到剪贴板');
            } catch (err) {
                console.error('复制失败:', err);
            }
            
            // 清理
            document.body.removeChild(textarea);
        }
        
        // 显示提示消息
        function showToast(message, duration = 2000) {
            // 移除现有的toast
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                document.body.removeChild(existingToast);
            }
            
            // 创建新的toast
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // 指定时间后隐藏toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // 启用任务编辑功能
        function enableTaskEditing(textElement) {
            // 设置为可编辑状态
            textElement.contentEditable = "true";
            textElement.classList.add('editing');
            textElement.focus();
            
            // 添加编辑提示（如果还没有）
            if (!textElement.getAttribute('data-tooltip')) {
                textElement.setAttribute('data-tooltip', '按Ctrl+Enter完成编辑');
                textElement.title = '按回车换行，按Ctrl+Enter完成编辑';
            }
        }

        // 工具函数：将HTML内容统一转为\n换行
        function htmlToPlainText(html) {
            if (!html) return '';
            // 1. 将 <div>、<p> 替换为换行
            let text = html.replace(/<div><br><\/div>/gi, '\n')
                           .replace(/<div>/gi, '\n')
                           .replace(/<\/div>/gi, '')
                           .replace(/<p>/gi, '\n')
                           .replace(/<\/p>/gi, '')
                           .replace(/<br\s*\/?>(?!\n)/gi, '\n');
            // 2. 去除多余的换行
            text = text.replace(/^\n+|\n+$/g, '');
            // 3. 转义HTML实体
            const temp = document.createElement('div');
            temp.innerHTML = text;
            return temp.textContent || temp.innerText || '';
        }
    </script>
</body>
</html> 


